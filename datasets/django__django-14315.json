{
  "instance_id": "django__django-14315",
  "problem_statement": "database client runshell doesn't respect os.environ values in some cases\nDescription\n\t \n\t\t(last modified by Konstantin Alekseev)\n\t \npostgresql client returns empty dict instead of None for env\nas a result os.environ is not used and empty env passed\nto subprocess.\nBug introduced in ​https://github.com/django/django/commit/bbe6fbb8768e8fb1aecb96d51c049d7ceaf802d3#diff-e98866ed4d445fbc94bb60bedffd5d8cf07af55dca6e8ffa4945931486efc3eeR23-R26\nPR ​https://github.com/django/django/pull/14315\n",
  "localized_code": "[start of django/db/backends/base/client.py]\n1: import os\n2: import subprocess\n3: \n4: \n5: class BaseDatabaseClient:\n6:     \"\"\"Encapsulate backend-specific methods for opening a client shell.\"\"\"\n7:     # This should be a string representing the name of the executable\n8:     # (e.g., \"psql\"). Subclasses must override this.\n9:     executable_name = None\n10: \n11:     def __init__(self, connection):\n12:         # connection is an instance of BaseDatabaseWrapper.\n13:         self.connection = connection\n14: \n15:     @classmethod\n16:     def settings_to_cmd_args_env(cls, settings_dict, parameters):\n17:         raise NotImplementedError(\n18:             'subclasses of BaseDatabaseClient must provide a '\n19:             'settings_to_cmd_args_env() method or override a runshell().'\n20:         )\n21: \n22:     def runshell(self, parameters):\n23:         args, env = self.settings_to_cmd_args_env(self.connection.settings_dict, parameters)\n24:         if env:\n25:             env = {**os.environ, **env}\n26:         subprocess.run(args, env=env, check=True)\n\n[start of django/db/backends/postgresql/client.py]\n1: import signal\n2: \n3: from django.db.backends.base.client import BaseDatabaseClient\n4: \n5: \n6: class DatabaseClient(BaseDatabaseClient):\n7:     executable_name = 'psql'\n8: \n9:     @classmethod\n10:     def settings_to_cmd_args_env(cls, settings_dict, parameters):\n11:         args = [cls.executable_name]\n12:         options = settings_dict.get('OPTIONS', {})\n13: \n14:         host = settings_dict.get('HOST')\n15:         port = settings_dict.get('PORT')\n16:         dbname = settings_dict.get('NAME')\n17:         user = settings_dict.get('USER')\n18:         passwd = settings_dict.get('PASSWORD')\n19:         passfile = options.get('passfile')\n20:         service = options.get('service')\n21:         sslmode = options.get('sslmode')\n22:         sslrootcert = options.get('sslrootcert')\n23:         sslcert = options.get('sslcert')\n24:         sslkey = options.get('sslkey')\n25: \n26:         if not dbname and not service:\n27:             # Connect to the default 'postgres' db.\n28:             dbname = 'postgres'\n29:         if user:\n30:             args += ['-U', user]\n31:         if host:\n32:             args += ['-h', host]\n33:         if port:\n34:             args += ['-p', str(port)]\n35:         if dbname:\n36:             args += [dbname]\n37:         args.extend(parameters)\n38: \n39:         env = {}\n40:         if passwd:\n41:             env['PGPASSWORD'] = str(passwd)\n42:         if service:\n43:             env['PGSERVICE'] = str(service)\n44:         if sslmode:\n45:             env['PGSSLMODE'] = str(sslmode)\n46:         if sslrootcert:\n47:             env['PGSSLROOTCERT'] = str(sslrootcert)\n48:         if sslcert:\n49:             env['PGSSLCERT'] = str(sslcert)\n50:         if sslkey:\n51:             env['PGSSLKEY'] = str(sslkey)\n52:         if passfile:\n53:             env['PGPASSFILE'] = str(passfile)\n54:         return args, env\n55: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/backends/base/client.py",
      "suspect_lines": [
        24,
        25
      ]
    },
    {
      "filename": "/django/db/backends/postgresql/client.py",
      "suspect_lines": [
        54
      ]
    }
  ]
}