{
  "instance_id": "django__django-16139",
  "problem_statement": "Accessing UserAdmin via to_field leads to link to PasswordResetForm being broken (404)\nDescription\n\t \n\t\t(last modified by Simon Kern)\n\t \nAccessing the UserAdmin via another model's Admin that has a reference to User (with to_field set, e.g., to_field=\"uuid\") leads to the UserAdmin being accessed via an url that looks similar to this one:\n.../user/22222222-3333-4444-5555-666677778888/change/?_to_field=uuid\nHowever the underlying form looks like this: \nCode highlighting:\nclass UserChangeForm(forms.ModelForm):\n\tpassword = ReadOnlyPasswordHashField(\n\t\tlabel=_(\"Password\"),\n\t\thelp_text=_(\n\t\t\t\"Raw passwords are not stored, so there is no way to see this \"\n\t\t\t\"user’s password, but you can change the password using \"\n\t\t\t'<a href=\"{}\">this form</a>.'\n\t\t),\n\t)\n\t...\n\t...\n\tdef __init__(self, *args, **kwargs):\n\t\tsuper().__init__(*args, **kwargs)\n\t\tpassword = self.fields.get(\"password\")\n\t\tif password:\n\t\t\tpassword.help_text = password.help_text.format(\"../password/\")\n\t...\n\t...\nThis results in the link to the PasswordResetForm being wrong and thus ending up in a 404. If we drop the assumption that UserAdmin is always accessed via its pk, then we're good to go. It's as simple as replacing password.help_text = password.help_text.format(\"../password/\") with password.help_text = password.help_text.format(f\"../../{self.instance.pk}/password/\")\nI've opened a pull request on GitHub for this Ticket, please see:\n​PR\n",
  "localized_code": "[start of django/contrib/auth/forms.py]\n1: import unicodedata\n2: \n3: from django import forms\n4: from django.contrib.auth import authenticate, get_user_model, password_validation\n5: from django.contrib.auth.hashers import UNUSABLE_PASSWORD_PREFIX, identify_hasher\n6: from django.contrib.auth.models import User\n7: from django.contrib.auth.tokens import default_token_generator\n8: from django.contrib.sites.shortcuts import get_current_site\n9: from django.core.exceptions import ValidationError\n10: from django.core.mail import EmailMultiAlternatives\n11: from django.template import loader\n12: from django.utils.encoding import force_bytes\n13: from django.utils.http import urlsafe_base64_encode\n14: from django.utils.text import capfirst\n15: from django.utils.translation import gettext\n16: from django.utils.translation import gettext_lazy as _\n17: \n18: UserModel = get_user_model()\n19: \n20: \n21: def _unicode_ci_compare(s1, s2):\n22:     \"\"\"\n23:     Perform case-insensitive comparison of two identifiers, using the\n24:     recommended algorithm from Unicode Technical Report 36, section\n25:     2.11.2(B)(2).\n26:     \"\"\"\n27:     return (\n28:         unicodedata.normalize(\"NFKC\", s1).casefold()\n29:         == unicodedata.normalize(\"NFKC\", s2).casefold()\n30:     )\n31: \n32: \n33: class ReadOnlyPasswordHashWidget(forms.Widget):\n34:     template_name = \"auth/widgets/read_only_password_hash.html\"\n35:     read_only = True\n36: \n37:     def get_context(self, name, value, attrs):\n38:         context = super().get_context(name, value, attrs)\n39:         summary = []\n40:         if not value or value.startswith(UNUSABLE_PASSWORD_PREFIX):\n41:             summary.append({\"label\": gettext(\"No password set.\")})\n42:         else:\n43:             try:\n44:                 hasher = identify_hasher(value)\n45:             except ValueError:\n46:                 summary.append(\n47:                     {\n48:                         \"label\": gettext(\n49:                             \"Invalid password format or unknown hashing algorithm.\"\n50:                         )\n51:                     }\n52:                 )\n53:             else:\n54:                 for key, value_ in hasher.safe_summary(value).items():\n55:                     summary.append({\"label\": gettext(key), \"value\": value_})\n56:         context[\"summary\"] = summary\n57:         return context\n58: \n59:     def id_for_label(self, id_):\n60:         return None\n61: \n62: \n63: class ReadOnlyPasswordHashField(forms.Field):\nCode replaced for brevity.\n69: \n70: \n71: \n72: class UsernameField(forms.CharField):\nCode replaced for brevity.\n81: \n82: \n83: \n84: class UserCreationForm(forms.ModelForm):\nCode replaced for brevity.\n144: \n145: \n146: \n147: class UserChangeForm(forms.ModelForm):\n148:     password = ReadOnlyPasswordHashField(\n149:         label=_(\"Password\"),\n150:         help_text=_(\n151:             \"Raw passwords are not stored, so there is no way to see this \"\n152:             \"user’s password, but you can change the password using \"\n153:             '<a href=\"{}\">this form</a>.'\n154:         ),\n155:     )\n156: \n157:     class Meta:\n158:         model = User\n159:         fields = \"__all__\"\n160:         field_classes = {\"username\": UsernameField}\n161: \n162:     def __init__(self, *args, **kwargs):\n163:         super().__init__(*args, **kwargs)\n164:         password = self.fields.get(\"password\")\n165:         if password:\n166:             password.help_text = password.help_text.format(\"../password/\")\n167:         user_permissions = self.fields.get(\"user_permissions\")\n168:         if user_permissions:\n169:             user_permissions.queryset = user_permissions.queryset.select_related(\n170:                 \"content_type\"\n171:             )\n172: \n173: \n174:     \"\"\"\nCode replaced for brevity.\n252: \n253: \n254: \n255:     emai\nCode replaced for brevity.\n350: \n351: \n352: \n353:     \"\"\"\nCode replaced for brevity.\n394: \n395: \n396: \n397:     \"\"\"\nCode replaced for brevity.\n429: \n430: \n431: \n432:     \"\"\"\nCode replaced for brevity.\n485: \n\n",
  "line_level_localization": [
    {
      "filename": "/django/contrib/auth/forms.py",
      "suspect_lines": [
        166
      ]
    }
  ]
}