{
  "instance_id": "django__django-14915",
  "problem_statement": "ModelChoiceIteratorValue is not hashable.\nDescription\n\t\nRecently I migrated from Django 3.0 to Django 3.1. In my code, I add custom data-* attributes to the select widget options. After the upgrade some of those options broke. Error is {TypeError}unhashable type: 'ModelChoiceIteratorValue'.\nExample (this one breaks):\n\tdef create_option(self, name, value, label, selected, index, subindex=None, attrs=None):\n\t\tcontext = super().create_option(name, value, label, selected, index, subindex, attrs)\n\t\tif not value:\n\t\t\treturn context\n\t\tif value in self.show_fields: # This is a dict {1: ['first_name', 'last_name']}\n\t\t\tcontext['attrs']['data-fields'] = json.dumps(self.show_fields[value])\nHowever, working with arrays is not an issue:\n\tdef create_option(self, name, value, label, selected, index, subindex=None, attrs=None):\n\t\tcontext = super().create_option(name, value, label, selected, index, subindex, attrs)\n\t\tif not value:\n\t\t\treturn context\n\t\tif value in allowed_values: # This is an array [1, 2]\n\t\t\t...\n",
  "localized_code": "[start of django/forms/models.py]\n1: \"\"\"\n2: Helper functions for creating Form classes from Django models\n3: and database field objects.\n4: \"\"\"\n5: from itertools import chain\n6: \n7: from django.core.exceptions import (\n8:     NON_FIELD_ERRORS, FieldError, ImproperlyConfigured, ValidationError,\n9: )\n10: from django.forms.fields import ChoiceField, Field\n11: from django.forms.forms import BaseForm, DeclarativeFieldsMetaclass\n12: from django.forms.formsets import BaseFormSet, formset_factory\n13: from django.forms.utils import ErrorList\n14: from django.forms.widgets import (\n15:     HiddenInput, MultipleHiddenInput, RadioSelect, SelectMultiple,\n16: )\n17: from django.utils.text import capfirst, get_text_list\n18: from django.utils.translation import gettext, gettext_lazy as _\n19: \n20: __all__ = (\n21:     'ModelForm', 'BaseModelForm', 'model_to_dict', 'fields_for_model',\n22:     'ModelChoiceField', 'ModelMultipleChoiceField', 'ALL_FIELDS',\n23:     'BaseModelFormSet', 'modelformset_factory', 'BaseInlineFormSet',\n24:     'inlineformset_factory', 'modelform_factory',\n25: )\n26: \n27: ALL_FIELDS = '__all__'\n28: \n29: \n30: def construct_instance(form, instance, fields=None, exclude=None):\n31:     \"\"\"\n32:     Construct and return a model instance from the bound ``form``'s\n33:     ``cleaned_data``, but do not save the returned instance to the database.\n34:     \"\"\"\n35:     from django.db import models\n36:     opts = instance._meta\n37: \n38:     cleaned_data = form.cleaned_data\n39:     file_field_list = []\n40:     for f in opts.fields:\n41:         if not f.editable or isinstance(f, models.AutoField) \\\n42:                 or f.name not in cleaned_data:\n43:             continue\n44:         if fields is not None and f.name not in fields:\n45:             continue\n46:         if exclude and f.name in exclude:\n47:             continue\n48:         # Leave defaults for fields that aren't in POST data, except for\n49:         # checkbox inputs because they don't appear in POST data if not checked.\n50:         if (\n51:             f.has_default() and\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/forms/models.py",
      "suspect_lines": []
    }
  ]
}