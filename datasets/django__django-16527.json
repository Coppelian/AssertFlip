{
  "instance_id": "django__django-16527",
  "problem_statement": "\"show_save_as_new\" in admin can add without this permission\nDescription\n\t \n\t\t(last modified by Mariusz Felisiak)\n\t \nAt \"django/contrib/admin/templatetags/admin_modify.py\" file, line 102, I think you must put one more verification for this tag: \"and has_add_permission\", because \"save_as_new\" is a add modification.\nI rewrite this for my project:\n\t\t\t\"show_save_as_new\": not is_popup\n\t\t\tand has_add_permission # This line that I put!!!\n\t\t\tand has_change_permission\n\t\t\tand change\n\t\t\tand save_as,\n",
  "localized_code": "[start of django/contrib/admin/templatetags/admin_modify.py]\n1: import json\n2: \n3: from django import template\n4: from django.template.context import Context\n5: \n6: from .base import InclusionAdminNode\n7: \n8: register = template.Library()\n9: \n10: \n11: def prepopulated_fields_js(context):\n12:     \"\"\"\n13:     Create a list of prepopulated_fields that should render JavaScript for\n14:     the prepopulated fields for both the admin form and inlines.\n15:     \"\"\"\n16:     prepopulated_fields = []\n17:     if \"adminform\" in context:\n18:         prepopulated_fields.extend(context[\"adminform\"].prepopulated_fields)\n19:     if \"inline_admin_formsets\" in context:\n20:         for inline_admin_formset in context[\"inline_admin_formsets\"]:\n21:             for inline_admin_form in inline_admin_formset:\n22:                 if inline_admin_form.original is None:\n23:                     prepopulated_fields.extend(inline_admin_form.prepopulated_fields)\n24: \n25:     prepopulated_fields_json = []\n26:     for field in prepopulated_fields:\n27:         prepopulated_fields_json.append(\n28:             {\n29:                 \"id\": \"#%s\" % field[\"field\"].auto_id,\n30:                 \"name\": field[\"field\"].name,\n31:                 \"dependency_ids\": [\n32:                     \"#%s\" % dependency.auto_id for dependency in field[\"dependencies\"]\n33:                 ],\n34:                 \"dependency_list\": [\n35:                     dependency.name for dependency in field[\"dependencies\"]\n36:                 ],\n37:                 \"maxLength\": field[\"field\"].field.max_length or 50,\n38:                 \"allowUnicode\": getattr(field[\"field\"].field, \"allow_unicode\", False),\n39:             }\n40:         )\n41: \n42:     context.update(\n43:         {\n44:             \"prepopulated_fields\": prepopulated_fields,\n45:             \"prepopulated_fields_json\": json.dumps(prepopulated_fields_json),\n46:         }\n47:     )\n48:     return context\n49: \n50: \n51: @register.tag(name=\"prepopulated_fields_js\")\n52: def prepopulated_fields_js_tag(parser, token):\nCode replaced for brevity.\n58: \n59: \n60: \n61: def submit_row(context):\n62:     \"\"\"\n63:     Display the row of buttons for delete and save.\n64:     \"\"\"\n65:     add = context[\"add\"]\n66:     change = context[\"change\"]\n67:     is_popup = context[\"is_popup\"]\n68:     save_as = context[\"save_as\"]\n69:     show_save = context.get(\"show_save\", True)\n70:     show_save_and_add_another = context.get(\"show_save_and_add_another\", True)\n71:     show_save_and_continue = context.get(\"show_save_and_continue\", True)\n72:     has_add_permission = context[\"has_add_permission\"]\n73:     has_change_permission = context[\"has_change_permission\"]\n74:     has_view_permission = context[\"has_view_permission\"]\n75:     has_editable_inline_admin_formsets = context[\"has_editable_inline_admin_formsets\"]\n76:     can_save = (\n77:         (has_change_permission and change)\n78:         or (has_add_permission and add)\n79:         or has_editable_inline_admin_formsets\n80:     )\n81:     can_save_and_add_another = (\n82:         has_add_permission\n83:         and not is_popup\n84:         and (not save_as or add)\n85:         and can_save\n86:         and show_save_and_add_another\n87:     )\n88:     can_save_and_continue = (\n89:         not is_popup and can_save and has_view_permission and show_save_and_continue\n90:     )\n91:     can_change = has_change_permission or has_editable_inline_admin_formsets\n92:     ctx = Context(context)\n93:     ctx.update(\n94:         {\n95:             \"can_change\": can_change,\n96:             \"show_delete_link\": (\n97:                 not is_popup\n98:                 and context[\"has_delete_permission\"]\n99:                 and change\n100:                 and context.get(\"show_delete\", True)\n101:             ),\n102:             \"show_save_as_new\": not is_popup\n103:             and has_change_permission\n104:             and change\n105:             and save_as,\n106:             \"show_save_and_add_another\": can_save_and_add_another,\n107:             \"show_save_and_continue\": can_save_and_continue,\n108:             \"show_save\": show_save and can_save,\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/contrib/admin/templatetags/admin_modify.py",
      "suspect_lines": [
        103
      ]
    }
  ]
}