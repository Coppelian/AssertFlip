{
  "instance_id": "django__django-17084",
  "problem_statement": "Cannot use aggregate over window functions since 4.2\nDescription\n\t \n\t\t(last modified by younes-chaoui)\n\t \nAfter upgrading to Django 4.2, I encountered an exception when executing ORM queries that involve aggregates over Window functions. The specific error was psycopg2.errors.GroupingError: aggregate function calls cannot contain window function calls\nDependencies :\npsycopg2 version: 2.9.3\ndjango version: 4.2.3\nPostgreSQL version: 13.4\nExample Code:\nqueryset = queryset.annotate(\n\tcumul_DJR=Coalesce(Window(Sum(\"DJR\"), order_by=F(\"date\").asc()), 0.0)\n)\naggregate = queryset.aggregate(\n\tDJR_total=Sum(\"DJR\"),\n\tcumul_DJR_total=Sum(\"cumul_DJR\")\n)\n",
  "localized_code": "[start of django/db/models/sql/query.py]\n1: \"\"\"\n2: Create SQL statements for QuerySets.\n3: \n4: The code in here encapsulates all of the SQL construction so that QuerySets\n5: themselves do not have to (and could be backed by things other than SQL\n6: databases). The abstraction barrier only works one way: this module has to know\n7: all about the internals of models in order to get the information it needs.\n8: \"\"\"\n9: import copy\n10: import difflib\n11: import functools\n12: import sys\n13: from collections import Counter, namedtuple\n14: from collections.abc import Iterator, Mapping\n15: from itertools import chain, count, product\n16: from string import ascii_uppercase\n17: \n18: from django.core.exceptions import FieldDoesNotExist, FieldError\n19: from django.db import DEFAULT_DB_ALIAS, NotSupportedError, connections\n20: from django.db.models.aggregates import Count\n21: from django.db.models.constants import LOOKUP_SEP\n22: from django.db.models.expressions import (\n23:     BaseExpression,\n24:     Col,\n25:     Exists,\n26:     F,\n27:     OuterRef,\n28:     Ref,\n29:     ResolvedOuterRef,\n30:     Value,\n31: )\n32: from django.db.models.fields import Field\n33: from django.db.models.fields.related_lookups import MultiColSource\n34: from django.db.models.lookups import Lookup\n35: from django.db.models.query_utils import (\n36:     Q,\n37:     check_rel_lookup_compatibility,\n38:     refs_expression,\n39: )\n40: from django.db.models.sql.constants import INNER, LOUTER, ORDER_DIR, SINGLE\n41: from django.db.models.sql.datastructures import BaseTable, Empty, Join, MultiJoin\n42: from django.db.models.sql.where import AND, OR, ExtraWhere, NothingNode, WhereNode\n43: from django.utils.functional import cached_property\n44: from django.utils.regex_helper import _lazy_re_compile\n45: from django.utils.tree import Node\n46: \n47: __all__ = [\"Query\", \"RawQuery\"]\n48: \n49: # Quotation marks ('\"`[]), whitespace characters, semicolons, or inline\n50: # SQL comments are forbidden in column aliases.\n51: FORBIDDEN_ALIAS_PATTERN = _lazy_re_compile(r\"['`\\\"\\]\\[;\\s]|--|/\\*|\\*/\")\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/models/sql/query.py",
      "suspect_lines": []
    }
  ]
}