{
  "instance_id": "sphinx-doc__sphinx-10673",
  "problem_statement": "toctree contains reference to nonexisting document 'genindex', 'modindex', 'search'\n**Is your feature request related to a problem? Please describe.**\r\nA lot of users try to add the following links to the toctree:\r\n```\r\n* :ref:`genindex`\r\n* :ref:`modindex`\r\n* :ref:`search`\r\n```\r\nlike this:\r\n```\r\n.. toctree::\r\n   :maxdepth: 1\r\n   :caption: Indices and tables\r\n\r\n   genindex \r\n   modindex\r\n   search\r\n```\r\n\r\nSee:\r\n* https://stackoverflow.com/questions/36235578/how-can-i-include-the-genindex-in-a-sphinx-toc\r\n* https://stackoverflow.com/questions/25243482/how-to-add-sphinx-generated-index-to-the-sidebar-when-using-read-the-docs-theme\r\n* https://stackoverflow.com/questions/40556423/how-can-i-link-the-generated-index-page-in-readthedocs-navigation-bar\r\n\r\nAnd probably more.\r\n\r\nHowever when doing this we get:\r\n```\r\n$ make html\r\n...\r\n.../index.rst:30: WARNING: toctree contains reference to nonexisting document 'genindex'\r\n.../index.rst:30: WARNING: toctree contains reference to nonexisting document 'modindex'\r\n.../index.rst:30: WARNING: toctree contains reference to nonexisting document 'search'\r\n...\r\n```\r\n\r\n**Describe the solution you'd like**\r\nThe following directive should be possible and do not rise errors:\r\n```\r\n.. toctree::\r\n   :maxdepth: 1\r\n   :caption: Indices and tables\r\n\r\n   genindex \r\n   modindex\r\n   search\r\n``\n",
  "localized_code": "[start of sphinx/directives/other.py]\n1: import re\n2: from typing import TYPE_CHECKING, Any, Dict, List, cast\n3: \n4: from docutils import nodes\n5: from docutils.nodes import Element, Node\n6: from docutils.parsers.rst import directives\n7: from docutils.parsers.rst.directives.admonitions import BaseAdmonition\n8: from docutils.parsers.rst.directives.misc import Class\n9: from docutils.parsers.rst.directives.misc import Include as BaseInclude\n10: \n11: from sphinx import addnodes\n12: from sphinx.domains.changeset import VersionChange  # NOQA  # for compatibility\n13: from sphinx.locale import _, __\n14: from sphinx.util import docname_join, logging, url_re\n15: from sphinx.util.docutils import SphinxDirective\n16: from sphinx.util.matching import Matcher, patfilter\n17: from sphinx.util.nodes import explicit_title_re\n18: from sphinx.util.typing import OptionSpec\n19: \n20: if TYPE_CHECKING:\n21:     from sphinx.application import Sphinx\n22: \n23: \n24: glob_re = re.compile(r'.*[*?\\[].*')\n25: logger = logging.getLogger(__name__)\n26: \n27: \n28: def int_or_nothing(argument: str) -> int:\n29:     if not argument:\n30:         return 999\n31:     return int(argument)\n32: \n33: \n34: class TocTree(SphinxDirective):\n35:     \"\"\"\n36:     Directive to notify Sphinx about the hierarchical structure of the docs,\n37:     and to include a table-of-contents like tree in the current document.\n38:     \"\"\"\n39:     has_content = True\n40:     required_arguments = 0\n41:     optional_arguments = 0\n42:     final_argument_whitespace = False\n43:     option_spec = {\n44:         'maxdepth': int,\n45:         'name': directives.unchanged,\n46:         'caption': directives.unchanged_required,\n47:         'glob': directives.flag,\n48:         'hidden': directives.flag,\n49:         'includehidden': directives.flag,\n50:         'numbered': int_or_nothing,\n51:         'titlesonly': directives.flag,\n52:         'reversed': directives.flag,\n53:     }\n54: \n55:     def run(self) -> List[Node]:\n56:         subnode = addnodes.toctree()\n57:         subnode['parent'] = self.env.docname\n58: \n59:         # (title, ref) pairs, where ref may be a document, or an external link,\n60:         # and title may be None if the document's title is to be used\n61:         subnode['entries'] = []\n62:         subnode['includefiles'] = []\n63:         subnode['maxdepth'] = self.options.get('maxdepth', -1)\n64:         subnode['caption'] = self.options.get('caption')\n65:         subnode['glob'] = 'glob' in self.options\n66:         subnode['hidden'] = 'hidden' in self.options\n67:         subnode['includehidden'] = 'includehidden' in self.options\n68:         subnode['numbered'] = self.options.get('numbered', 0)\n69:         subnode['titlesonly'] = 'titlesonly' in self.options\n70:         self.set_source_info(subnode)\n71:         wrappernode = nodes.compound(classes=['toctree-wrapper'])\n72:         wrappernode.append(subnode)\n73:         self.add_name(wrappernode)\n74: \n75:         ret = self.parse_content(subnode)\n76:         ret.append(wrappernode)\n77:         return ret\n78: \n79:     def parse_content(self, toctree: addnodes.toctree) -> List[Node]:\n80:         suffixes = self.config.source_suffix\n81: \n82:         # glob target documents\n83:         all_docnames = self.env.found_docs.copy()\n84:         all_docnames.remove(self.env.docname)  # remove current document\n85: \n86:         ret: List[Node] = []\n87:         excluded = Matcher(self.config.exclude_patterns)\n88:         for entry in self.content:\n89:             if not entry:\n90:                 continue\n91:             # look for explicit titles (\"Some Title <document>\")\n92:             explicit = explicit_title_re.match(entry)\n93:             if (toctree['glob'] and glob_re.match(entry) and\n94:                     not explicit and not url_re.match(entry)):\n95:                 patname = docname_join(self.env.docname, entry)\n96:                 docnames = sorted(patfilter(all_docnames, patname))\n97:                 for docname in docnames:\n98:                     all_docnames.remove(docname)  # don't include it again\n99:                     toctree['entries'].append((None, docname))\n100:                     toctree['includefiles'].append(docname)\n101:                 if not docnames:\n102:                     logger.warning(__('toctree glob pattern %r didn\\'t match any documents'),\n103:                                    entry, location=toctree)\n104:             else:\n105:                 if explicit:\n106:                     ref = explicit.group(2)\n107:                     title = explicit.group(1)\n108:                     docname = ref\n109:                 else:\n110:                     ref = docname = entry\n111:                     title = None\n112:                 # remove suffixes (backwards compatibility)\n113:                 for suffix in suffixes:\n114:                     if docname.endswith(suffix):\n115:                         docname = docname[:-len(suffix)]\n116:                         break\n117:                 # absolutize filenames\n118:                 docname = docname_join(self.env.docname, docname)\n119:                 if url_re.match(ref) or ref == 'self':\n120:                     toctree['entries'].append((title, ref))\n121:                 elif docname not in self.env.found_docs:\n122:                     if excluded(self.env.doc2path(docname, False)):\n... Code Truncated ...\n\n[start of sphinx/environment/adapters/toctree.py]\n1: \"\"\"Toctree adapter for sphinx.environment.\"\"\"\n2: \n3: from typing import TYPE_CHECKING, Any, Iterable, List, Optional, cast\n4: \n5: from docutils import nodes\n6: from docutils.nodes import Element, Node\n7: \n8: from sphinx import addnodes\n9: from sphinx.locale import __\n10: from sphinx.util import logging, url_re\n11: from sphinx.util.matching import Matcher\n12: from sphinx.util.nodes import clean_astext, process_only_nodes\n13: \n14: if TYPE_CHECKING:\n15:     from sphinx.builders import Builder\n16:     from sphinx.environment import BuildEnvironment\n17: \n18: \n19: logger = logging.getLogger(__name__)\n20: \n21: \n22: class TocTree:\n23:     def __init__(self, env: \"BuildEnvironment\") -> None:\n24:         self.env = env\n25: \n26:     def note(self, docname: str, toctreenode: addnodes.toctree) -> None:\n27:         \"\"\"Note a TOC tree directive in a document and gather information about\n28:         file relations from it.\n29:         \"\"\"\n30:         if toctreenode['glob']:\n31:             self.env.glob_toctrees.add(docname)\n32:         if toctreenode.get('numbered'):\n33:             self.env.numbered_toctrees.add(docname)\n34:         includefiles = toctreenode['includefiles']\n35:         for includefile in includefiles:\n36:             # note that if the included file is rebuilt, this one must be\n37:             # too (since the TOC of the included file could have changed)\n38:             self.env.files_to_rebuild.setdefault(includefile, set()).add(docname)\n39:         self.env.toctree_includes.setdefault(docname, []).extend(includefiles)\n40: \n41:     def resolve(self, docname: str, builder: \"Builder\", toctree: addnodes.toctree,\n42:                 prune: bool = True, maxdepth: int = 0, titles_only: bool = False,\n43:                 collapse: bool = False, includehidden: bool = False) -> Optional[Element]:\n44:         \"\"\"Resolve a *toctree* node into individual bullet lists with titles\n45:         as items, returning None (if no containing titles are found) or\n46:         a new node.\n47: \n48:         If *prune* is True, the tree is pruned to *maxdepth*, or if that is 0,\n49:         to the value of the *maxdepth* option on the *toctree* node.\n50:         If *titles_only* is True, only toplevel document titles will be in the\n51:         resulting tree.\n... Code Truncated ...\n\n[start of sphinx/environment/collectors/toctree.py]\n1: \"\"\"Toctree collector for sphinx.environment.\"\"\"\n2: \n3: from typing import Any, Dict, List, Optional, Set, Tuple, Type, TypeVar, cast\n4: \n5: from docutils import nodes\n6: from docutils.nodes import Element, Node\n7: \n8: from sphinx import addnodes\n9: from sphinx.application import Sphinx\n10: from sphinx.environment import BuildEnvironment\n11: from sphinx.environment.adapters.toctree import TocTree\n12: from sphinx.environment.collectors import EnvironmentCollector\n13: from sphinx.locale import __\n14: from sphinx.transforms import SphinxContentsFilter\n15: from sphinx.util import logging, url_re\n16: \n17: N = TypeVar('N')\n18: \n19: logger = logging.getLogger(__name__)\n20: \n21: \n22: class TocTreeCollector(EnvironmentCollector):\n23:     def clear_doc(self, app: Sphinx, env: BuildEnvironment, docname: str) -> None:\n24:         env.tocs.pop(docname, None)\n25:         env.toc_secnumbers.pop(docname, None)\n26:         env.toc_fignumbers.pop(docname, None)\n27:         env.toc_num_entries.pop(docname, None)\n28:         env.toctree_includes.pop(docname, None)\n29:         env.glob_toctrees.discard(docname)\n30:         env.numbered_toctrees.discard(docname)\n31: \n32:         for subfn, fnset in list(env.files_to_rebuild.items()):\n33:             fnset.discard(docname)\n34:             if not fnset:\n35:                 del env.files_to_rebuild[subfn]\n36: \n37:     def merge_other(self, app: Sphinx, env: BuildEnvironment, docnames: Set[str],\n38:                     other: BuildEnvironment) -> None:\n39:         for docname in docnames:\n40:             env.tocs[docname] = other.tocs[docname]\n41:             env.toc_num_entries[docname] = other.toc_num_entries[docname]\n42:             if docname in other.toctree_includes:\n43:                 env.toctree_includes[docname] = other.toctree_includes[docname]\n44:             if docname in other.glob_toctrees:\n45:                 env.glob_toctrees.add(docname)\n46:             if docname in other.numbered_toctrees:\n47:                 env.numbered_toctrees.add(docname)\n48: \n49:         for subfn, fnset in other.files_to_rebuild.items():\n50:             env.files_to_rebuild.setdefault(subfn, set()).update(fnset & set(docnames))\n51: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/sphinx/directives/other.py",
      "suspect_lines": [
        83,
        121
      ]
    },
    {
      "filename": "/sphinx/environment/adapters/toctree.py",
      "suspect_lines": [
        3
      ]
    },
    {
      "filename": "/sphinx/environment/collectors/toctree.py",
      "suspect_lines": []
    }
  ]
}