{
  "instance_id": "matplotlib__matplotlib-23299",
  "problem_statement": "[Bug]: get_backend() clears figures from Gcf.figs if they were created under rc_context\n### Bug summary\r\n\r\ncalling `matplotlib.get_backend()` removes all figures from `Gcf` if the *first* figure in `Gcf.figs` was created in an `rc_context`.\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\nfrom matplotlib import get_backend, rc_context\r\n\r\n# fig1 = plt.figure()  # <- UNCOMMENT THIS LINE AND IT WILL WORK\r\n# plt.ion()            # <- ALTERNATIVELY, UNCOMMENT THIS LINE AND IT WILL ALSO WORK\r\nwith rc_context():\r\n    fig2 = plt.figure()\r\nbefore = f'{id(plt._pylab_helpers.Gcf)} {plt._pylab_helpers.Gcf.figs!r}'\r\nget_backend()\r\nafter = f'{id(plt._pylab_helpers.Gcf)} {plt._pylab_helpers.Gcf.figs!r}'\r\n\r\nassert before == after, '\\n' + before + '\\n' + after\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nAssertionError                            Traceback (most recent call last)\r\n<ipython-input-1-fa4d099aa289> in <cell line: 11>()\r\n      9 after = f'{id(plt._pylab_helpers.Gcf)} {plt._pylab_helpers.Gcf.figs!r}'\r\n     10 \r\n---> 11 assert before == after, '\\n' + before + '\\n' + after\r\n     12 \r\n\r\nAssertionError: \r\n94453354309744 OrderedDict([(1, <matplotlib.backends.backend_qt.FigureManagerQT object at 0x7fb33e26c220>)])\r\n94453354309744 OrderedDict()\r\n```\r\n\r\n### Expected outcome\r\n\r\nThe figure should not be missing from `Gcf`.  Consequences of this are, e.g, `plt.close(fig2)` doesn't work because `Gcf.destroy_fig()` can't find it.\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nXubuntu\r\n\r\n### Matplotlib Version\r\n\r\n3.5.2\r\n\r\n### Matplotlib Backend\r\n\r\nQtAgg\r\n\r\n### Python version\r\n\r\nPython 3.10.4\r\n\r\n### Jupyter version\r\n\r\nn/a\r\n\r\n### Installation\r\n\r\nconda\n",
  "localized_code": "[start of lib/matplotlib/__init__.py]\n1: \"\"\"\n2: An object-oriented plotting library.\n3: \n4: A procedural interface is provided by the companion pyplot module,\n5: which may be imported directly, e.g.::\n6: \n7:     import matplotlib.pyplot as plt\n8: \n9: or using ipython::\n10: \n11:     ipython\n12: \n13: at your terminal, followed by::\n14: \n15:     In [1]: %matplotlib\n16:     In [2]: import matplotlib.pyplot as plt\n17: \n18: at the ipython shell prompt.\n19: \n20: For the most part, direct use of the explicit object-oriented library is\n21: encouraged when programming; the implicit pyplot interface is primarily for\n22: working interactively. The exceptions to this suggestion are the pyplot\n23: functions `.pyplot.figure`, `.pyplot.subplot`, `.pyplot.subplots`, and\n24: `.pyplot.savefig`, which can greatly simplify scripting.  See\n25: :ref:`api_interfaces` for an explanation of the tradeoffs between the implicit\n26: and explicit interfaces.\n27: \n28: Modules include:\n29: \n30:     :mod:`matplotlib.axes`\n31:         The `~.axes.Axes` class.  Most pyplot functions are wrappers for\n32:         `~.axes.Axes` methods.  The axes module is the highest level of OO\n33:         access to the library.\n34: \n35:     :mod:`matplotlib.figure`\n36:         The `.Figure` class.\n37: \n38:     :mod:`matplotlib.artist`\n39:         The `.Artist` base class for all classes that draw things.\n40: \n41:     :mod:`matplotlib.lines`\n42:         The `.Line2D` class for drawing lines and markers.\n43: \n44:     :mod:`matplotlib.patches`\n45:         Classes for drawing polygons.\n46: \n47:     :mod:`matplotlib.text`\n48:         The `.Text` and `.Annotation` classes.\n49: \n50:     :mod:`matplotlib.image`\n51:         The `.AxesImage` and `.FigureImage` classes.\n52: \n53:     :mod:`matplotlib.collections`\n54:         Classes for efficient drawing of groups of lines or polygons.\n55: \n56:     :mod:`matplotlib.colors`\n57:         Color specifications and making colormaps.\n58: \n59:     :mod:`matplotlib.cm`\n60:         Colormaps, and the `.ScalarMappable` mixin class for providing color\n61:         mapping functionality to other classes.\n62: \n63:     :mod:`matplotlib.ticker`\n64:         Calculation of tick mark locations and formatting of tick labels.\n65: \n66:     :mod:`matplotlib.backends`\n67:         A subpackage with modules for various GUI libraries and output formats.\n68: \n69: The base matplotlib namespace includes:\n70: \n71:     `~matplotlib.rcParams`\n72:         Default configuration settings; their defaults may be overridden using\n73:         a :file:`matplotlibrc` file.\n74: \n75:     `~matplotlib.use`\n76:         Setting the Matplotlib backend.  This should be called before any\n77:         figure is created, because it is not possible to switch between\n78:         different GUI backends after that.\n79: \n80: Matplotlib was initially written by John D. Hunter (1968-2012) and is now\n81: developed and maintained by a host of others.\n82: \n83: Occasionally the internal documentation (python docstrings) will refer\n84: to MATLAB&reg;, a registered trademark of The MathWorks, Inc.\n85: \n86: \"\"\"\n87: \n88: import atexit\n89: from collections import namedtuple\n90: from collections.abc import MutableMapping\n91: import contextlib\n92: import functools\n93: import importlib\n94: import inspect\n95: from inspect import Parameter\n96: import locale\n97: import logging\n98: import os\n99: from pathlib import Path\n100: import pprint\n101: import re\n102: import shutil\n103: import subprocess\n104: import sys\n105: import tempfile\n106: import warnings\n107: \n108: import numpy\n109: from packaging.version import parse as parse_version\n110: \n111: # cbook must import matplotlib only within function\n112: # definitions, so it is safe to import from it here.\n113: from . import _api, _version, cbook, _docstring, rcsetup\n114: from matplotlib.cbook import sanitize_sequence\n115: from matplotlib._api import MatplotlibDeprecationWarning\n116: from matplotlib.rcsetup import validate_backend, cycler\n117: \n118: \n119: _log = logging.getLogger(__name__)\n120: \n121: __bibtex__ = r\"\"\"@Article{Hunter:2007,\n122:   Author    = {Hunter, J. D.},\n123:   Title     = {Matplotlib: A 2D graphics environment},\n124:   Journal   = {Computing in Science \\& Engineering},\n125:   Volume    = {9},\n126:   Number    = {3},\n127:   Pages     = {90--95},\n128:   abstract  = {Matplotlib is a 2D graphics package used for Python\n129:   for application development, interactive scripting, and\n130:   publication-quality image generation across user\n131:   interfaces and operating systems.},\n132:   publisher = {IEEE COMPUTER SOC},\n133:   year      = 2007\n134: }\"\"\"\n135: \n136: # modelled after sys.version_info\n137: _VersionInfo = namedtuple('_VersionInfo',\n138:                           'major, minor, micro, releaselevel, serial')\n139: \n140: \n141: def _parse_to_version_info(version_str):\nCode replaced for brevity.\n162: \n163: \n164: \n165: def _get_version():\nCode replaced for brevity.\n182: \n183: \n184: \n185: @_api.caching_module_getattr\n186: class __getattr__:\nCode replaced for brevity.\n192: \n193: \n194: \n195:     # DLLs are loaded before importing kiwisolver\nCode replaced for brevity.\n211: \n212: \n213: \n214: _check_versions()\n215: \n216: \n217: # The decorator ensures this always returns the same handler (and it is only\n218: # attached once).\n219: @functools.lru_cache()\n220: def _ensure_handler():\nCode replaced for brevity.\n230: \n231: \n232: \n233: def set_loglevel(level):\nCode replaced for brevity.\n253: \n254: \n255: \n256: def _logged_cached(fmt, func=None):\nCode replaced for brevity.\n284: \n285: \n286: \n287: _ExecInfo = namedtuple(\"_ExecInfo\", \"executable raw_version version\")\n288: \n289: \n290: class ExecutableNotFoundError(FileNotFoundError):\nCode replaced for brevity.\n295: \n296: \n297: \n298: @functools.lru_cache()\n299: def _get_executable_info(name):\nCode replaced for brevity.\n436: \n437: \n438: \n439: @_api.deprecated(\"3.6\", alternative=\"Vendor the code\")\n440: def checkdep_usetex(s):\nCode replaced for brevity.\n456: \n457: \n458: \n459: def _get_xdg_config_dir():\nCode replaced for brevity.\n466: \n467: \n468: \n469: def _get_xdg_cache_dir():\nCode replaced for brevity.\n475: \n476: \n477: \n478: def _get_config_or_cache_dir(xdg_base_getter):\nCode replaced for brevity.\n507: \n508: \n509: \n510: @_logged_cached('CONFIGDIR=%s')\n511: def get_configdir():\nCode replaced for brevity.\n526: \n527: \n528: \n529: @_logged_cached('CACHEDIR=%s')\n530: def get_cachedir():\nCode replaced for brevity.\n537: \n538: \n539: \n540: @_logged_cached('matplotlib data path: %s')\n541: def get_data_path():\nCode replaced for brevity.\n543: \n544: \n545: \n546: def matplotlib_fname():\nCode replaced for brevity.\n588: \n589: \n590: \n591: # rcParams deprecated and automatically mapped to another key.\n592: # Values are tuples of (version, new_name, f_old2new, f_new2old).\n593: _deprecated_map = {}\n594: # rcParams deprecated; some can manually be mapped to another key.\n595: # Values are tuples of (version, new_name_or_None).\n596: _deprecated_ignore_map = {}\n597: # rcParams deprecated; can use None to suppress warnings; remain actually\n598: # listed in the rcParams.\n599: # Values are tuples of (version,)\n600: _deprecated_remain_as_none = {}\n601: \n602: \n603: @_docstring.Substitution(\n604:     \"\\n\".join(map(\"- {}\".format, sorted(rcsetup._validators, key=str.lower)))\n605: )\n606: class RcParams(MutableMapping, dict):\nCode replaced for brevity.\n726: \n727: \n728: \n729: def rc_params(fail_on_error=False):\nCode replaced for brevity.\n731: \n732: \n733: \n734: @_api.deprecated(\"3.5\")\n735: def is_url(filename):\nCode replaced for brevity.\n737: \n738: \n739: \n740: @functools.lru_cache()\n741: def _get_ssl_context():\nCode replaced for brevity.\n748: \n749: \n750: \n751: @contextlib.contextmanager\n752: def _open_file_or_url(fname):\nCode replaced for brevity.\n766: \n767: \n768: \n769: def _rc_params_in_file(fname, transform=lambda x: x, fail_on_error=False):\nCode replaced for brevity.\n843: \n844: \n845: \n846: def rc_params_from_file(fname, fail_on_error=False, use_default_template=True):\nCode replaced for brevity.\n879: \n880: \n881: \n882: # When constructing the global instances, we need to perform certain updates\n883: # by explicitly calling the superclass (dict.update, dict.items) to avoid\n884: # triggering resolution of _auto_backend_sentinel.\n885: rcParamsDefault = _rc_params_in_file(\n886:     cbook._get_data_path(\"matplotlibrc\"),\n887:     # Strip leading comment.\n888:     transform=lambda line: line[1:] if line.startswith(\"#\") else line,\n889:     fail_on_error=True)\n890: dict.update(rcParamsDefault, rcsetup._hardcoded_defaults)\n891: # Normally, the default matplotlibrc file contains *no* entry for backend (the\n892: # corresponding line starts with ##, not #; we fill on _auto_backend_sentinel\n893: # in that case.  However, packagers can set a different default backend\n894: # (resulting in a normal `#backend: foo` line) in which case we should *not*\n895: # fill in _auto_backend_sentinel.\n896: dict.setdefault(rcParamsDefault, \"backend\", rcsetup._auto_backend_sentinel)\n897: rcParams = RcParams()  # The global instance.\n898: dict.update(rcParams, dict.items(rcParamsDefault))\n899: dict.update(rcParams, _rc_params_in_file(matplotlib_fname()))\n900: rcParamsOrig = rcParams.copy()\n901: with _api.suppress_matplotlib_deprecation_warning():\n902:     # This also checks that all rcParams are indeed listed in the template.\n903:     # Assigning to rcsetup.defaultParams is left only for backcompat.\n904:     defaultParams = rcsetup.defaultParams = {\n905:         # We want to resolve deprecated rcParams, but not backend...\n906:         key: [(rcsetup._auto_backend_sentinel if key == \"backend\" else\n907:                rcParamsDefault[key]),\n908:               validator]\n909:         for key, validator in rcsetup._validators.items()}\n910: if rcParams['axes.formatter.use_locale']:\n911:     locale.setlocale(locale.LC_ALL, '')\n912: \n913: \n914: def rc(group, **kwargs):\nCode replaced for brevity.\n987: \n988: \n989: \n990: def rcdefaults():\nCode replaced for brevity.\n1012: \n1013: \n1014: \n1015: def rc_file_defaults():\nCode replaced for brevity.\n1027: \n1028: \n1029: \n1030: def rc_file(fname, *, use_default_template=True):\nCode replaced for brevity.\n1054: \n1055: \n1056: \n1057: @contextlib.contextmanager\n1058: def rc_context(rc=None, fname=None):\n1059:     \"\"\"\n1060:     Return a context manager for temporarily changing rcParams.\n1061: \n1062:     Parameters\n1063:     ----------\n1064:     rc : dict\n1065:         The rcParams to temporarily set.\n1066:     fname : str or path-like\n1067:         A file with Matplotlib rc settings. If both *fname* and *rc* are given,\n1068:         settings from *rc* take precedence.\n1069: \n1070:     See Also\n1071:     --------\n1072:     :ref:`customizing-with-matplotlibrc-files`\n1073: \n1074:     Examples\n1075:     --------\n1076:     Passing explicit values via a dict::\n1077: \n1078:         with mpl.rc_context({'interactive': False}):\n1079:             fig, ax = plt.subplots()\n1080:             ax.plot(range(3), range(3))\n1081:             fig.savefig('example.png')\n1082:             plt.close(fig)\n1083: \n1084:     Loading settings from a file::\n1085: \n1086:          with mpl.rc_context(fname='print.rc'):\n1087:              plt.plot(x, y)  # uses 'print.rc'\n1088: \n1089:     \"\"\"\n1090:     orig = rcParams.copy()\n1091:     try:\n1092:         if fname:\n1093:             rc_file(fname)\n1094:         if rc:\n1095:             rcParams.update(rc)\n1096:         yield\n1097:     finally:\n1098:         dict.update(rcParams, orig)  # Revert to the original rcs.\n1099: \n1100: \n1101: def use(backend, *, force=True):\nCode replaced for brevity.\n1163: \n1164: \n1165: \n1166: if os.environ.get('MPLBACKEND'):\n1167:     rcParams['backend'] = os.environ.get('MPLBACKEND')\n1168: \n1169: \n1170: def get_backend():\nCode replaced for brevity.\n1178: \n1179: \n1180: \n1181: def interactive(b):\nCode replaced for brevity.\n1185: \n1186: \n1187: \n1188: def is_interactive():\nCode replaced for brevity.\n1197: \n1198: \n1199: \n1200: default_test_modules = [\n1201:     'matplotlib.tests',\n1202:     'mpl_toolkits.tests',\n1203: ]\n1204: \n1205: \n1206:     # tests.  This must match the value in `setupext.py`\nCode replaced for brevity.\n1221: \n1222: \n1223: \n1224: @_api.deprecated(\"3.5\", alternative='pytest')\n1225: def test(verbosity=None, coverage=False, **kwargs):\nCode replaced for brevity.\n1270: \n1271: \n1272: \n1273: test.__test__ = False  # pytest: this function is not a test\n1274: \n1275: \n1276: def _replacer(data, value):\nCode replaced for brevity.\n1289: \n1290: \n1291: \n1292: def _label_from_arg(y, default_name):\nCode replaced for brevity.\n1298: \n1299: \n1300: \n1301: def _add_data_doc(docstring, replace_names):\nCode replaced for brevity.\n1342: \n1343: \n1344: \n1345: def _preprocess_data(func=None, *, replace_names=None, label_namer=None):\nCode replaced for brevity.\n1449: \n1450: \n1451: \n1452: _log.debug('interactive is %s', is_interactive())\n1453: _log.debug('platform is %s', sys.platform)\n1454: \n1455: \n1456: # workaround: we must defer colormaps import to after loading rcParams, because\n1457: # colormap creation depends on rcParams\n1458: from matplotlib.cm import _colormaps as colormaps\n1459: from matplotlib.colors import _color_sequences as color_sequences\n\n",
  "line_level_localization": [
    {
      "filename": "/lib/matplotlib/__init__.py",
      "suspect_lines": [
        1090
      ]
    }
  ]
}