{
  "instance_id": "django__django-12125",
  "problem_statement": "makemigrations produces incorrect path for inner classes\nDescription\n\t\nWhen you define a subclass from django.db.models.Field as an inner class of some other class, and use this field inside a django.db.models.Model class, then when you run manage.py makemigrations, a migrations file is created which refers to the inner class as if it were a top-level class of the module it is in.\nTo reproduce, create the following as your model:\nclass Outer(object):\n\tclass Inner(models.CharField):\n\t\tpass\nclass A(models.Model):\n\tfield = Outer.Inner(max_length=20)\nAfter running manage.py makemigrations, the generated migrations file contains the following:\nmigrations.CreateModel(\n\tname='A',\n\tfields=[\n\t\t('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n\t\t('field', test1.models.Inner(max_length=20)),\n\t],\n),\nNote the test1.models.Inner, which should have been test1.models.Outer.Inner.\nThe real life case involved an EnumField from django-enumfields, defined as an inner class of a Django Model class, similar to this:\nimport enum\nfrom enumfields import Enum, EnumField\nclass Thing(models.Model):\n\t@enum.unique\n\tclass State(Enum):\n\t\ton = 'on'\n\t\toff = 'off'\n\tstate = EnumField(enum=State)\nThis results in the following migrations code:\nmigrations.CreateModel(\n\tname='Thing',\n\tfields=[\n\t\t('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n\t\t('state', enumfields.fields.EnumField(enum=test1.models.State, max_length=10)),\n\t],\n),\nThis refers to test1.models.State, instead of to test1.models.Thing.State.\n",
  "localized_code": "[start of django/db/migrations/serializer.py]\n1: import builtins\n2: import collections.abc\n3: import datetime\n4: import decimal\n5: import enum\n6: import functools\n7: import math\n8: import re\n9: import types\n10: import uuid\n11: \n12: from django.conf import SettingsReference\n13: from django.db import models\n14: from django.db.migrations.operations.base import Operation\n15: from django.db.migrations.utils import COMPILED_REGEX_TYPE, RegexObject\n16: from django.utils.functional import LazyObject, Promise\n17: from django.utils.timezone import utc\n18: from django.utils.version import get_docs_version\n19: \n20: \n21: class BaseSerializer:\n22:     def __init__(self, value):\n23:         self.value = value\n24: \n25:     def serialize(self):\n26:         raise NotImplementedError('Subclasses of BaseSerializer must implement the serialize() method.')\n27: \n28: \n29: class BaseSequenceSerializer(BaseSerializer):\n30:     def _format(self):\n31:         raise NotImplementedError('Subclasses of BaseSequenceSerializer must implement the _format() method.')\n32: \n33:     def serialize(self):\n34:         imports = set()\n35:         strings = []\n36:         for item in self.value:\n37:             item_string, item_imports = serializer_factory(item).serialize()\n38:             imports.update(item_imports)\n39:             strings.append(item_string)\n40:         value = self._format()\n41:         return value % (\", \".join(strings)), imports\n42: \n43: \n44: class BaseSimpleSerializer(BaseSerializer):\n45:     def serialize(self):\n46:         return repr(self.value), set()\n47: \n48: \n49: class ChoicesSerializer(BaseSerializer):\n50:     def serialize(self):\n51:         return serializer_factory(self.value.value).serialize()\n52: \n53: \n54: class DateTimeSerializer(BaseSerializer):\nCode replaced for brevity.\n57: \n58: \n59: \n60: class DatetimeDatetimeSerializer(BaseSerializer):\nCode replaced for brevity.\n68: \n69: \n70: \n71: class DecimalSerializer(BaseSerializer):\nCode replaced for brevity.\n73: \n74: \n75: \n76: class DeconstructableSerializer(BaseSerializer):\nCode replaced for brevity.\n103: \n104: \n105: \n106: class DictionarySerializer(BaseSerializer):\nCode replaced for brevity.\n116: \n117: \n118: \n119: class EnumSerializer(BaseSerializer):\nCode replaced for brevity.\n126: \n127: \n128: \n129: class FloatSerializer(BaseSimpleSerializer):\nCode replaced for brevity.\n133: \n134: \n135: \n136: class FrozensetSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n138: \n139: \n140: \n141: class FunctionTypeSerializer(BaseSerializer):\nCode replaced for brevity.\n160: \n161: \n162: \n163: class FunctoolsPartialSerializer(BaseSerializer):\nCode replaced for brevity.\n179: \n180: \n181: \n182: class IterableSerializer(BaseSerializer):\nCode replaced for brevity.\n193: \n194: \n195: \n196: class ModelFieldSerializer(DeconstructableSerializer):\nCode replaced for brevity.\n199: \n200: \n201: \n202: class ModelManagerSerializer(DeconstructableSerializer):\nCode replaced for brevity.\n209: \n210: \n211: \n212: class OperationSerializer(BaseSerializer):\nCode replaced for brevity.\n217: \n218: \n219: \n220: class RegexSerializer(BaseSerializer):\nCode replaced for brevity.\n231: \n232: \n233: \n234: class SequenceSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n236: \n237: \n238: \n239: class SetSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n243: \n244: \n245: \n246: class SettingsReferenceSerializer(BaseSerializer):\nCode replaced for brevity.\n248: \n249: \n250: \n251: class TupleSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n255: \n256: \n257: \n258: class TypeSerializer(BaseSerializer):\n259:     def serialize(self):\n260:         special_cases = [\n261:             (models.Model, \"models.Model\", []),\n262:             (type(None), 'type(None)', []),\n263:         ]\n264:         for case, string, imports in special_cases:\n265:             if case is self.value:\n266:                 return string, set(imports)\n267:         if hasattr(self.value, \"__module__\"):\n268:             module = self.value.__module__\n269:             if module == builtins.__name__:\n270:                 return self.value.__name__, set()\n271:             else:\n272:                 return \"%s.%s\" % (module, self.value.__name__), {\"import %s\" % module}\n273: \n274: \n275: class UUIDSerializer(BaseSerializer):\nCode replaced for brevity.\n277: \n278: \n279: \n280: class Serializer:\nCode replaced for brevity.\n311: \n312: \n313: \n314: def serializer_factory(value):\nCode replaced for brevity.\n340: \n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/migrations/serializer.py",
      "suspect_lines": [
        272
      ]
    }
  ]
}