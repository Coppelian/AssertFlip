{
  "instance_id": "django__django-14855",
  "problem_statement": "Wrong URL generated by get_admin_url for readonly field in custom Admin Site\nDescription\n\t\nWhen a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....\nThis appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:\nurl = reverse(url_name, args=[quote(remote_obj.pk)])\nOther parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)\nI have been able to correct this specific issue by replacing the above line with:\nurl = reverse(\n\turl_name,\n\targs=[quote(remote_obj.pk)],\n\tcurrent_app=self.model_admin.admin_site.name\n)\nHowever, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.\n",
  "localized_code": "[start of django/contrib/admin/helpers.py]\n1: import json\n2: \n3: from django import forms\n4: from django.contrib.admin.utils import (\n5:     display_for_field, flatten_fieldsets, help_text_for_field, label_for_field,\n6:     lookup_field, quote,\n7: )\n8: from django.core.exceptions import ObjectDoesNotExist\n9: from django.db.models.fields.related import (\n10:     ForeignObjectRel, ManyToManyRel, OneToOneField,\n11: )\n12: from django.forms.utils import flatatt\n13: from django.template.defaultfilters import capfirst, linebreaksbr\n14: from django.urls import NoReverseMatch, reverse\n15: from django.utils.html import conditional_escape, format_html\n16: from django.utils.safestring import mark_safe\n17: from django.utils.translation import gettext, gettext_lazy as _\n18: \n19: ACTION_CHECKBOX_NAME = '_selected_action'\n20: \n21: \n22: class ActionForm(forms.Form):\n23:     action = forms.ChoiceField(label=_('Action:'))\n24:     select_across = forms.BooleanField(\n25:         label='',\n26:         required=False,\n27:         initial=0,\n28:         widget=forms.HiddenInput({'class': 'select-across'}),\n29:     )\n30: \n31: \n32: checkbox = forms.CheckboxInput({'class': 'action-select'}, lambda value: False)\n33: \n34: \n35: class AdminForm:\n36:     def __init__(self, form, fieldsets, prepopulated_fields, readonly_fields=None, model_admin=None):\n37:         self.form, self.fieldsets = form, fieldsets\n38:         self.prepopulated_fields = [{\n39:             'field': form[field_name],\n40:             'dependencies': [form[f] for f in dependencies]\n41:         } for field_name, dependencies in prepopulated_fields.items()]\n42:         self.model_admin = model_admin\n43:         if readonly_fields is None:\n44:             readonly_fields = ()\n45:         self.readonly_fields = readonly_fields\n46: \n47:     def __repr__(self):\n48:         return (\n49:             f'<{self.__class__.__qualname__}: '\n50:             f'form={self.form.__class__.__qualname__} '\n51:             f'fieldsets={self.fieldsets!r}>'\n52:         )\n53: \n54:     def __iter__(self):\n55:         for name, options in self.fieldsets:\n56:             yield Fieldset(\n57:                 self.form, name,\n58:                 readonly_fields=self.readonly_fields,\n59:                 model_admin=self.model_admin,\n60:                 **options\n61:             )\n62: \n63:     @property\n64:     def errors(self):\n65:         return self.form.errors\n66: \n67:     @property\n68:     def non_field_errors(self):\n69:         return self.form.non_field_errors\n70: \n71:     @property\n72:     def media(self):\n73:         media = self.form.media\n74:         for fs in self:\n75:             media = media + fs.media\n76:         return media\n77: \n78: \n79: class Fieldset:\nCode replaced for brevity.\n97: \n98: \n99: \n100: class Fieldline:\nCode replaced for brevity.\n128: \n129: \n130: \n131: class AdminField:\nCode replaced for brevity.\n157: \n158: \n159: \n160: class AdminReadonlyField:\n161:     def __init__(self, form, field, is_first, model_admin=None):\n162:         # Make self.field look a little bit like a field. This means that\n163:         # {{ field.name }} must be a useful class name to identify the field.\n164:         # For convenience, store other field-related data here too.\n165:         if callable(field):\n166:             class_name = field.__name__ if field.__name__ != '<lambda>' else ''\n167:         else:\n168:             class_name = field\n169: \n170:         if form._meta.labels and class_name in form._meta.labels:\n171:             label = form._meta.labels[class_name]\n172:         else:\n173:             label = label_for_field(field, form._meta.model, model_admin, form=form)\n174: \n175:         if form._meta.help_texts and class_name in form._meta.help_texts:\n176:             help_text = form._meta.help_texts[class_name]\n177:         else:\n178:             help_text = help_text_for_field(class_name, form._meta.model)\n179: \n180:         if field in form.fields:\n181:             is_hidden = form.fields[field].widget.is_hidden\n182:         else:\n183:             is_hidden = False\n184: \n185:         self.field = {\n186:             'name': class_name,\n187:             'label': label,\n188:             'help_text': help_text,\n189:             'field': field,\n190:             'is_hidden': is_hidden,\n191:         }\n192:         self.form = form\n193:         self.model_admin = model_admin\n194:         self.is_first = is_first\n195:         self.is_checkbox = False\n196:         self.is_readonly = True\n197:         self.empty_value_display = model_admin.get_empty_value_display()\n198: \n199:     def label_tag(self):\n200:         attrs = {}\n201:         if not self.is_first:\n202:             attrs[\"class\"] = \"inline\"\n203:         label = self.field['label']\n204:         return format_html('<label{}>{}{}</label>', flatatt(attrs), capfirst(label), self.form.label_suffix)\n205: \n206:     def get_admin_url(self, remote_field, remote_obj):\n207:         url_name = 'admin:%s_%s_change' % (\n208:             remote_field.model._meta.app_label,\n209:             remote_field.model._meta.model_name,\n210:         )\n211:         try:\n212:             url = reverse(url_name, args=[quote(remote_obj.pk)])\n213:             return format_html('<a href=\"{}\">{}</a>', url, remote_obj)\n214:         except NoReverseMatch:\n215:             return str(remote_obj)\n216: \n217:     def contents(self):\n218:         from django.contrib.admin.templatetags.admin_list import _boolean_icon\n219:         field, obj, model_admin = self.field['field'], self.form.instance, self.model_admin\n220:         try:\n221:             f, attr, value = lookup_field(field, obj, model_admin)\n222:         except (AttributeError, ValueError, ObjectDoesNotExist):\n223:             result_repr = self.empty_value_display\n224:         else:\n225:             if field in self.form.fields:\n226:                 widget = self.form[field].field.widget\n227:                 # This isn't elegant but suffices for contrib.auth's\n228:                 # ReadOnlyPasswordHashWidget.\n229:                 if getattr(widget, 'read_only', False):\n230:                     return widget.render(field, value)\n231:             if f is None:\n232:                 if getattr(attr, 'boolean', False):\n233:                     result_repr = _boolean_icon(value)\n234:                 else:\n235:                     if hasattr(value, \"__html__\"):\n236:                         result_repr = value\n237:                     else:\n238:                         result_repr = linebreaksbr(value)\n239:             else:\n240:                 if isinstance(f.remote_field, ManyToManyRel) and value is not None:\n241:                     result_repr = \", \".join(map(str, value.all()))\n242:                 elif (\n243:                     isinstance(f.remote_field, (ForeignObjectRel, OneToOneField)) and\n244:                     value is not None\n245:                 ):\n246:                     result_repr = self.get_admin_url(f.remote_field, value)\n247:                 else:\n248:                     result_repr = display_for_field(value, f, self.empty_value_display)\n249:                 result_repr = linebreaksbr(result_repr)\n250:         return conditional_escape(result_repr)\n251: \n252: \n253: class InlineAdminFormSet:\nCode replaced for brevity.\n366: \n367: \n368: \n369: class InlineAdminForm(AdminForm):\nCode replaced for brevity.\n416: \n417: \n418: \n419: class InlineFieldset(Fieldset):\nCode replaced for brevity.\n428: \n429: \n430: \n431: class AdminErrorList(forms.utils.ErrorList):\nCode replaced for brevity.\n441: \n\n",
  "line_level_localization": [
    {
      "filename": "/django/contrib/admin/helpers.py",
      "suspect_lines": [
        212
      ]
    }
  ]
}