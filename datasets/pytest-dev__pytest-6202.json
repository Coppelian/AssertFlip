{
  "instance_id": "pytest-dev__pytest-6202",
  "problem_statement": "'.['  replaced with '[' in the headline shown of the test report\n```\r\nbug.py F                                                                 [100%]\r\n\r\n=================================== FAILURES ===================================\r\n_________________________________ test_boo[.[] _________________________________\r\n\r\na = '..['\r\n\r\n    @pytest.mark.parametrize(\"a\",[\"..[\"])\r\n    def test_boo(a):\r\n>       assert 0\r\nE       assert 0\r\n\r\nbug.py:6: AssertionError\r\n============================== 1 failed in 0.06s ===============================\r\n```\r\n\r\nThe `\"test_boo[..[]\"` replaced with `\"test_boo[.[]\"` in the headline shown with long report output.\r\n\r\n**The same problem also causing the vscode-python test discovery error.**\r\n\r\n## What causing the problem\r\n\r\nI trace back the source code.\r\n\r\n[https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/reports.py#L129-L149](https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/reports.py#L129-L149)\r\n\r\nThe headline comes from line 148.\r\n\r\n[https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/nodes.py#L432-L441](https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/nodes.py#L432-L441)\r\n\r\n`location` comes from line 437 `location = self.reportinfo()`\r\n\r\n[https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/python.py#L294-L308](https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/python.py#L294-L308)\r\n\r\nThe headline comes from line 306 `modpath = self.getmodpath() `\r\n\r\n[https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/python.py#L274-L292](https://github.com/pytest-dev/pytest/blob/92d6a0500b9f528a9adcd6bbcda46ebf9b6baf03/src/_pytest/python.py#L274-L292)\r\n\r\nThis line of code `return s.replace(\".[\", \"[\")` causes the problem. We should replace it with `return s`. After changing this, run `tox -e linting,py37`, pass all the tests and resolve this issue. But I can't find this line of code for what purpose.\n",
  "localized_code": "[start of src/_pytest/python.py]\n1: \"\"\" Python test discovery, setup and run of test functions. \"\"\"\n2: import enum\n3: import fnmatch\n4: import inspect\n5: import os\n6: import sys\n7: import warnings\n8: from collections import Counter\n9: from collections.abc import Sequence\n10: from functools import partial\n11: from textwrap import dedent\n12: \n13: import py\n14: \n15: import _pytest\n16: from _pytest import fixtures\n17: from _pytest import nodes\n18: from _pytest._code import filter_traceback\n19: from _pytest.compat import ascii_escaped\n20: from _pytest.compat import get_default_arg_names\n21: from _pytest.compat import get_real_func\n22: from _pytest.compat import getfslineno\n23: from _pytest.compat import getimfunc\n24: from _pytest.compat import getlocation\n25: from _pytest.compat import is_generator\n26: from _pytest.compat import iscoroutinefunction\n27: from _pytest.compat import NOTSET\n28: from _pytest.compat import REGEX_TYPE\n29: from _pytest.compat import safe_getattr\n30: from _pytest.compat import safe_isclass\n31: from _pytest.compat import STRING_TYPES\n32: from _pytest.config import hookimpl\n33: from _pytest.main import FSHookProxy\n34: from _pytest.mark import MARK_GEN\n35: from _pytest.mark.structures import get_unpacked_marks\n36: from _pytest.mark.structures import normalize_mark_list\n37: from _pytest.outcomes import fail\n38: from _pytest.outcomes import skip\n39: from _pytest.pathlib import parts\n40: from _pytest.warning_types import PytestCollectionWarning\n41: from _pytest.warning_types import PytestUnhandledCoroutineWarning\n42: \n43: \n44: def pyobj_property(name):\n45:     def get(self):\n46:         node = self.getparent(getattr(__import__(\"pytest\"), name))\n47:         if node is not None:\n48:             return node.obj\n49: \n50:     doc = \"python {} object this node was collected from (can be None).\".format(\n51:         name.lower()\n52:     )\n53:     return property(get, None, None, doc)\n54: \n55: \n56: def pytest_addoption(parser):\nCode replaced for brevity.\n108: \n109: \n110: \n111: def pytest_cmdline_main(config):\nCode replaced for brevity.\n117: \n118: \n119: \n120:     # the user\nCode replaced for brevity.\n129: \n130: \n131: \n132: def pytest_configure(config):\nCode replaced for brevity.\n149: \n150: \n151: \n152: @hookimpl(trylast=True)\n153: def pytest_pyfunc_call(pyfuncitem):\nCode replaced for brevity.\n173: \n174: \n175: \n176: def pytest_collect_file(path, parent):\nCode replaced for brevity.\n185: \n186: \n187: \n188: def path_matches_patterns(path, patterns):\nCode replaced for brevity.\n190: \n191: \n192: \n193: def pytest_pycollect_makemodule(path, parent):\nCode replaced for brevity.\n196: \n197: \n198: \n199: @hookimpl(hookwrapper=True)\n200: def pytest_pycollect_makeitem(collector, name, obj):\nCode replaced for brevity.\n235: \n236: \n237: \n238: def pytest_make_parametrize_id(config, val, argname=None):\n239:     return None\n240: \n241: \n242: class PyobjContext:\nCode replaced for brevity.\n245: \n246: \n247: \n248: class PyobjMixin(PyobjContext):\n249:     _ALLOW_MARKERS = True\n250: \n251:     @property\n252:     def obj(self):\n253:         \"\"\"Underlying Python object.\"\"\"\n254:         obj = getattr(self, \"_obj\", None)\n255:         if obj is None:\n256:             self._obj = obj = self._getobj()\n257:             # XXX evil hack\n258:             # used to avoid Instance collector marker duplication\n259:             if self._ALLOW_MARKERS:\n260:                 self.own_markers.extend(get_unpacked_marks(self.obj))\n261:         return obj\n262: \n263:     @obj.setter\n264:     def obj(self, value):\n265:         self._obj = value\n266: \n267:     def _getobj(self):\n268:         \"\"\"Gets the underlying Python object. May be overwritten by subclasses.\"\"\"\n269:         return getattr(self.parent.obj, self.name)\n270: \n271:     def getmodpath(self, stopatmodule=True, includemodule=False):\n272:         \"\"\" return python path relative to the containing module. \"\"\"\n273:         chain = self.listchain()\n274:         chain.reverse()\n275:         parts = []\n276:         for node in chain:\n277:             if isinstance(node, Instance):\n278:                 continue\n279:             name = node.name\n280:             if isinstance(node, Module):\n281:                 name = os.path.splitext(name)[0]\n282:                 if stopatmodule:\n283:                     if includemodule:\n284:                         parts.append(name)\n285:                     break\n286:             parts.append(name)\n287:         parts.reverse()\n288:         s = \".\".join(parts)\n289:         return s.replace(\".[\", \"[\")\n290: \n291:     def reportinfo(self):\n292:         # XXX caching?\n293:         obj = self.obj\n294:         compat_co_firstlineno = getattr(obj, \"compat_co_firstlineno\", None)\n295:         if isinstance(compat_co_firstlineno, int):\n296:             # nose compatibility\n297:             fspath = sys.modules[obj.__module__].__file__\n298:             if fspath.endswith(\".pyc\"):\n299:                 fspath = fspath[:-1]\n300:             lineno = compat_co_firstlineno\n301:         else:\n302:             fspath, lineno = getfslineno(obj)\n303:         modpath = self.getmodpath()\n304:         assert isinstance(lineno, int)\n305:         return fspath, lineno, modpath\n306: \n307: \n308: class PyCollector(PyobjMixin, nodes.Collector):\nCode replaced for brevity.\n426: \n427: \n428: \n429: class Module(nodes.File, PyCollector):\nCode replaced for brevity.\n545: \n546: \n547: \n548: class Package(Module):\nCode replaced for brevity.\n658: \n659: \n660: \n661: def _call_with_optional_argument(func, arg):\nCode replaced for brevity.\n670: \n671: \n672: \n673: def _get_first_non_fixture_func(obj, names):\nCode replaced for brevity.\n681: \n682: \n683: \n684: class Class(PyCollector):\nCode replaced for brevity.\n761: \n762: \n763: \n764: class Instance(PyCollector):\nCode replaced for brevity.\n779: \n780: \n781: \n782: class FunctionMixin(PyobjMixin):\nCode replaced for brevity.\n818: \n819: \n820: \n821: def hasinit(obj):\nCode replaced for brevity.\n824: \n825: \n826: \n827: def hasnew(obj):\nCode replaced for brevity.\n830: \n831: \n832: \n833: class CallSpec2:\nCode replaced for brevity.\n881: \n882: \n883: \n884: class Metafunc(fixtures.FuncargnamesCompatAttr):\nCode replaced for brevity.\n1098: \n1099: \n1100: \n1101: def _find_parametrized_scope(argnames, arg2fixturedefs, indirect):\nCode replaced for brevity.\n1131: \n1132: \n1133: \n1134: def _ascii_escaped_by_config(val, config):\nCode replaced for brevity.\n1141: \n1142: \n1143: \n1144: def _idval(val, argname, idx, idfn, item, config):\nCode replaced for brevity.\n1172: \n1173: \n1174: \n1175: def _idvalset(idx, parameterset, argnames, idfn, ids, item, config):\nCode replaced for brevity.\n1185: \n1186: \n1187: \n1188: def idmaker(argnames, parametersets, idfn=None, ids=None, config=None, item=None):\nCode replaced for brevity.\n1201: \n1202: \n1203: \n1204: def show_fixtures_per_test(config):\nCode replaced for brevity.\n1207: \n1208: \n1209: \n1210: def _show_fixtures_per_test(config, session):\nCode replaced for brevity.\n1259: \n1260: \n1261: \n1262: def showfixtures(config):\nCode replaced for brevity.\n1265: \n1266: \n1267: \n1268: def _showfixtures_main(config, session):\nCode replaced for brevity.\n1322: \n1323: \n1324: \n1325: def write_docstring(tw, doc, indent=\"    \"):\nCode replaced for brevity.\n1337: \n1338: \n1339: \n1340: class Function(FunctionMixin, nodes.Item, fixtures.FuncargnamesCompatAttr):\nCode replaced for brevity.\n1433: \n1434: \n1435: \n1436: class FunctionDefinition(Function):\nCode replaced for brevity.\n1445: \n\n",
  "line_level_localization": [
    {
      "filename": "/src/_pytest/python.py",
      "suspect_lines": [
        288,
        289
      ]
    }
  ]
}