{
  "instance_id": "django__django-14493",
  "problem_statement": "ManifestStaticFilesStorage crashes with max_post_process_passes = 0.\nDescription\n\t\nTo reproduce:\nDerive a custom class from ManifestStaticFilesStorage and set max_post_process_passes to 0:\nclass MyManifestStaticFilesStorage(ManifestStaticFilesStorage):\n\tmax_post_process_passes = 0\n# settings.py\nSTATICFILES_STORAGE = \"MyManifestStaticFilesStorage\"\nrun collectstatic\n File \"lib/python3.7/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py\", line 188, in handle\n\tcollected = self.collect()\n File \"lib/python3.7/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py\", line 128, in collect\n\tfor original_path, processed_path, processed in processor:\n File \"lib/python3.7/site-packages/django/contrib/staticfiles/storage.py\", line 403, in post_process\n\tyield from super().post_process(*args, **kwargs)\n File \"lib/python3.7/site-packages/django/contrib/staticfiles/storage.py\", line 251, in post_process\n\tif substitutions:\nUnboundLocalError: local variable 'substitutions' referenced before assignment\nThe error can also be seen easily in the code: â€‹https://github.com/django/django/blob/a0a5e0f4c83acdfc6eab69754e245354689c7185/django/contrib/staticfiles/storage.py#L246-L257\nsubtitutions is only set if the loop is entered at least once.\n(The motivation to set max_post_process_passes to 0 is to have Django not produce invalid CSS as described here: https://code.djangoproject.com/ticket/21080#comment:19 )\n",
  "localized_code": "[start of django/contrib/staticfiles/storage.py]\n1: import hashlib\n2: import json\n3: import os\n4: import posixpath\n5: import re\n6: from urllib.parse import unquote, urldefrag, urlsplit, urlunsplit\n7: \n8: from django.conf import settings\n9: from django.contrib.staticfiles.utils import check_settings, matches_patterns\n10: from django.core.exceptions import ImproperlyConfigured\n11: from django.core.files.base import ContentFile\n12: from django.core.files.storage import FileSystemStorage, get_storage_class\n13: from django.utils.functional import LazyObject\n14: \n15: \n16: class StaticFilesStorage(FileSystemStorage):\n17:     \"\"\"\n18:     Standard file system storage for static files.\n19: \n20:     The defaults for ``location`` and ``base_url`` are\n21:     ``STATIC_ROOT`` and ``STATIC_URL``.\n22:     \"\"\"\n23:     def __init__(self, location=None, base_url=None, *args, **kwargs):\n24:         if location is None:\n25:             location = settings.STATIC_ROOT\n26:         if base_url is None:\n27:             base_url = settings.STATIC_URL\n28:         check_settings(base_url)\n29:         super().__init__(location, base_url, *args, **kwargs)\n30:         # FileSystemStorage fallbacks to MEDIA_ROOT when location\n31:         # is empty, so we restore the empty value.\n32:         if not location:\n33:             self.base_location = None\n34:             self.location = None\n35: \n36:     def path(self, name):\n37:         if not self.location:\n38:             raise ImproperlyConfigured(\"You're using the staticfiles app \"\n39:                                        \"without having set the STATIC_ROOT \"\n40:                                        \"setting to a filesystem path.\")\n41:         return super().path(name)\n42: \n43: \n44: class HashedFilesMixin:\n45:     default_template = \"\"\"url(\"%(url)s\")\"\"\"\n46:     max_post_process_passes = 5\n47:     patterns = (\n48:         (\"*.css\", (\n49:             r\"\"\"(?P<matched>url\\(['\"]{0,1}\\s*(?P<url>.*?)[\"']{0,1}\\))\"\"\",\n50:             (\n51:                 r\"\"\"(?P<matched>@import\\s*[\"']\\s*(?P<url>.*?)[\"'])\"\"\",\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/contrib/staticfiles/storage.py",
      "suspect_lines": []
    }
  ]
}