{
  "instance_id": "django__django-14792",
  "problem_statement": "Reverse time zone conversion in Trunc()/Extract() database functions.\nDescription\n\t\nWhen using a time zone of \"Etc/GMT-10\" (or similar) for a Trunc class tzinfo, it appears there's a different behavior as of Django 3.2 in the resulting database query. I think it's due to a change in the return value of timezone._get_timezone_name() that's called by the TimezoneMixin.\nOn Django 3.1 the TimezoneMixin method get_tzname() returns \"+10\" for a \"Etc/GMT-10\" time zone after calling ​_get_timezone_name(). This later becomes \"-10\" in the resulting query due to the return value of _prepare_tzname_delta() of the Postgres DatabaseOperations class, i.e. the time zone 10 hours east from UTC.\nSELECT ... DATE_TRUNC(\\'day\\', \"my_model\".\"start_at\" AT TIME ZONE \\'-10\\') AS \"date\" ...\nOn Django 3.2 the TimezoneMixin method get_tzname() returns \"Etc/GMT-10\" for a \"Etc/GMT-10\" time zone after calling ​_get_timezone_name(). This later, incorrectly, becomes \"Etc/GMT+10\" in the resulting query due to the return value of _prepare_tzname_delta() of the Postgres DatabaseOperations class, i.e. the time zone 10 hours west from UTC, which is the opposite direction from the behavior in Django 3.1.\nSELECT ... DATE_TRUNC(\\'day\\', \"my_model\".\"start_at\" AT TIME ZONE \\'Etc/GMT+10\\') AS \"date\" ...\n# Django 3.1\n>>> timezone._get_timezone_name(pytz.timezone(\"Etc/GMT-10\"))\n'+10'\n# Django 3.2\n>>> timezone._get_timezone_name(pytz.timezone(\"Etc/GMT-10\"))\n'Etc/GMT-10'\nThe above is the same when using Python's zoneinfo.ZoneInfo() too.\n",
  "localized_code": "[start of django/utils/timezone.py]\n1: \"\"\"\n2: Timezone-related classes and functions.\n3: \"\"\"\n4: \n5: import functools\n6: from contextlib import ContextDecorator\n7: from datetime import datetime, timedelta, timezone, tzinfo\n8: \n9: import pytz\n10: from asgiref.local import Local\n11: \n12: from django.conf import settings\n13: \n14: __all__ = [\n15:     'utc', 'get_fixed_timezone',\n16:     'get_default_timezone', 'get_default_timezone_name',\n17:     'get_current_timezone', 'get_current_timezone_name',\n18:     'activate', 'deactivate', 'override',\n19:     'localtime', 'now',\n20:     'is_aware', 'is_naive', 'make_aware', 'make_naive',\n21: ]\n22: \n23: \n24: # UTC time zone as a tzinfo instance.\n25: utc = pytz.utc\n26: \n27: _PYTZ_BASE_CLASSES = (pytz.tzinfo.BaseTzInfo, pytz._FixedOffset)\n28: # In releases prior to 2018.4, pytz.UTC was not a subclass of BaseTzInfo\n29: if not isinstance(pytz.UTC, pytz._FixedOffset):\n30:     _PYTZ_BASE_CLASSES = _PYTZ_BASE_CLASSES + (type(pytz.UTC),)\n31: \n32: \n33: def get_fixed_timezone(offset):\n34:     \"\"\"Return a tzinfo instance with a fixed offset from UTC.\"\"\"\n35:     if isinstance(offset, timedelta):\n36:         offset = offset.total_seconds() // 60\n37:     sign = '-' if offset < 0 else '+'\n38:     hhmm = '%02d%02d' % divmod(abs(offset), 60)\n39:     name = sign + hhmm\n40:     return timezone(timedelta(minutes=offset), name)\n41: \n42: \n43: # In order to avoid accessing settings at compile time,\n44: # wrap the logic in a function and cache the result.\n45: @functools.lru_cache()\n46: def get_default_timezone():\n47:     \"\"\"\n48:     Return the default time zone as a tzinfo instance.\n49: \n50:     This is the time zone defined by settings.TIME_ZONE.\n51:     \"\"\"\n52:     return pytz.timezone(settings.TIME_ZONE)\n53: \n54: \n55: # This function exists for consistency with get_current_timezone_name\n56: def get_default_timezone_name():\nCode replaced for brevity.\n58: \n59: \n60: \n61: _active = Local()\n62: \n63: \n64: def get_current_timezone():\nCode replaced for brevity.\n66: \n67: \n68: \n69: def get_current_timezone_name():\nCode replaced for brevity.\n71: \n72: \n73: \n74: def _get_timezone_name(timezone):\n75:     \"\"\"Return the name of ``timezone``.\"\"\"\n76:     return str(timezone)\n77: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/utils/timezone.py",
      "suspect_lines": [
        75,
        76
      ]
    }
  ]
}