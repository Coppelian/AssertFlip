{
  "instance_id": "django__django-15930",
  "problem_statement": "Case() crashes with ~Q(pk__in=[]).\nDescription\n\t\nThe following code generates a syntax error. \nUser.objects.annotate(\n\t_a=Case(\n\t\tWhen(~Q(pk__in=[]), then=Value(True)),\n\t\tdefault=Value(False),\n\t\toutput_field=BooleanField(),\n\t)\n).order_by(\"-a\").values(\"pk\")\nThe error is: \nProgrammingError: syntax error at or near \"THEN\"\nLINE 1: ..._user\".\"id\" FROM \"users_user\" ORDER BY CASE WHEN THEN true ...\nThe generated SQL is: \nSELECT \"users_user\".\"id\" FROM \"users_user\" ORDER BY CASE WHEN THEN True ELSE False END ASC\nI expected behavior to annotate all rows with the value True since they all match.\nRelevant because ~Q(pkin=[]) is a sentinel value that is sometimes returned by application code.\n",
  "localized_code": "[start of django/db/models/expressions.py]\n1: import copy\n2: import datetime\n3: import functools\n4: import inspect\n5: import warnings\n6: from collections import defaultdict\n7: from decimal import Decimal\n8: from uuid import UUID\n9: \n10: from django.core.exceptions import EmptyResultSet, FieldError\n11: from django.db import DatabaseError, NotSupportedError, connection\n12: from django.db.models import fields\n13: from django.db.models.constants import LOOKUP_SEP\n14: from django.db.models.query_utils import Q\n15: from django.utils.deconstruct import deconstructible\n16: from django.utils.deprecation import RemovedInDjango50Warning\n17: from django.utils.functional import cached_property\n18: from django.utils.hashable import make_hashable\n19: \n20: \n21: class SQLiteNumericMixin:\n22:     \"\"\"\n23:     Some expressions with output_field=DecimalField() must be cast to\n24:     numeric to be properly filtered.\n25:     \"\"\"\n26: \n27:     def as_sqlite(self, compiler, connection, **extra_context):\n28:         sql, params = self.as_sql(compiler, connection, **extra_context)\n29:         try:\n30:             if self.output_field.get_internal_type() == \"DecimalField\":\n31:                 sql = \"CAST(%s AS NUMERIC)\" % sql\n32:         except FieldError:\n33:             pass\n34:         return sql, params\n35: \n36: \n37: class Combinable:\n38:     \"\"\"\n39:     Provide the ability to combine one or two objects with\n40:     some connector. For example F('foo') + F('bar').\n41:     \"\"\"\n42: \n43:     # Arithmetic connectors\n44:     ADD = \"+\"\n45:     SUB = \"-\"\n46:     MUL = \"*\"\n47:     DIV = \"/\"\n48:     POW = \"^\"\n49:     # The following is a quoted % operator - it is quoted because it can be\n50:     # used in strings that also have parameter substitution.\n51:     MOD = \"%%\"\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/models/expressions.py",
      "suspect_lines": []
    }
  ]
}