{
  "instance_id": "django__django-14580",
  "problem_statement": "Missing import statement in generated migration (NameError: name 'models' is not defined)\nDescription\n\t\nI found a bug in Django's latest release: 3.2.4. \nGiven the following contents of models.py:\nfrom django.db import models\nclass MyField(models.TextField):\n\tpass\nclass MyBaseModel(models.Model):\n\tclass Meta:\n\t\tabstract = True\nclass MyMixin:\n\tpass\nclass MyModel(MyMixin, MyBaseModel):\n\tname = MyField(primary_key=True)\nThe makemigrations command will generate the following migration file:\n# Generated by Django 3.2.4 on 2021-06-30 19:13\nimport app.models\nfrom django.db import migrations\nclass Migration(migrations.Migration):\n\tinitial = True\n\tdependencies = [\n\t]\n\toperations = [\n\t\tmigrations.CreateModel(\n\t\t\tname='MyModel',\n\t\t\tfields=[\n\t\t\t\t('name', app.models.MyField(primary_key=True, serialize=False)),\n\t\t\t],\n\t\t\toptions={\n\t\t\t\t'abstract': False,\n\t\t\t},\n\t\t\tbases=(app.models.MyMixin, models.Model),\n\t\t),\n\t]\nWhich will then fail with the following error:\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 7, in <module>\n\tclass Migration(migrations.Migration):\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 23, in Migration\n\tbases=(app.models.MyMixin, models.Model),\nNameError: name 'models' is not defined\nExpected behavior: Django generates a migration file that is valid Python.\nActual behavior: Django generates a migration file that is missing an import statement.\nI think this is a bug of the module django.db.migrations.writer, but I'm not sure. I will be happy to assist with debugging.\nThanks for your attention,\nJaap Joris\n",
  "localized_code": "[start of django/db/migrations/serializer.py]\n1: import builtins\n2: import collections.abc\n3: import datetime\n4: import decimal\n5: import enum\n6: import functools\n7: import math\n8: import os\n9: import pathlib\n10: import re\n11: import types\n12: import uuid\n13: \n14: from django.conf import SettingsReference\n15: from django.db import models\n16: from django.db.migrations.operations.base import Operation\n17: from django.db.migrations.utils import COMPILED_REGEX_TYPE, RegexObject\n18: from django.utils.functional import LazyObject, Promise\n19: from django.utils.timezone import utc\n20: from django.utils.version import get_docs_version\n21: \n22: \n23: class BaseSerializer:\n24:     def __init__(self, value):\n25:         self.value = value\n26: \n27:     def serialize(self):\n28:         raise NotImplementedError('Subclasses of BaseSerializer must implement the serialize() method.')\n29: \n30: \n31: class BaseSequenceSerializer(BaseSerializer):\n32:     def _format(self):\n33:         raise NotImplementedError('Subclasses of BaseSequenceSerializer must implement the _format() method.')\n34: \n35:     def serialize(self):\n36:         imports = set()\n37:         strings = []\n38:         for item in self.value:\n39:             item_string, item_imports = serializer_factory(item).serialize()\n40:             imports.update(item_imports)\n41:             strings.append(item_string)\n42:         value = self._format()\n43:         return value % (\", \".join(strings)), imports\n44: \n45: \n46: class BaseSimpleSerializer(BaseSerializer):\n47:     def serialize(self):\n48:         return repr(self.value), set()\n49: \n50: \n51: class ChoicesSerializer(BaseSerializer):\nCode replaced for brevity.\n53: \n54: \n55: \n56: class DateTimeSerializer(BaseSerializer):\nCode replaced for brevity.\n59: \n60: \n61: \n62: class DatetimeDatetimeSerializer(BaseSerializer):\nCode replaced for brevity.\n70: \n71: \n72: \n73: class DecimalSerializer(BaseSerializer):\nCode replaced for brevity.\n75: \n76: \n77: \n78: class DeconstructableSerializer(BaseSerializer):\nCode replaced for brevity.\n105: \n106: \n107: \n108: class DictionarySerializer(BaseSerializer):\nCode replaced for brevity.\n118: \n119: \n120: \n121: class EnumSerializer(BaseSerializer):\nCode replaced for brevity.\n128: \n129: \n130: \n131: class FloatSerializer(BaseSimpleSerializer):\nCode replaced for brevity.\n135: \n136: \n137: \n138: class FrozensetSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n140: \n141: \n142: \n143: class FunctionTypeSerializer(BaseSerializer):\nCode replaced for brevity.\n162: \n163: \n164: \n165: class FunctoolsPartialSerializer(BaseSerializer):\nCode replaced for brevity.\n181: \n182: \n183: \n184: class IterableSerializer(BaseSerializer):\nCode replaced for brevity.\n195: \n196: \n197: \n198: class ModelFieldSerializer(DeconstructableSerializer):\nCode replaced for brevity.\n201: \n202: \n203: \n204: class ModelManagerSerializer(DeconstructableSerializer):\nCode replaced for brevity.\n211: \n212: \n213: \n214: class OperationSerializer(BaseSerializer):\nCode replaced for brevity.\n219: \n220: \n221: \n222: class PathLikeSerializer(BaseSerializer):\nCode replaced for brevity.\n224: \n225: \n226: \n227: class PathSerializer(BaseSerializer):\nCode replaced for brevity.\n232: \n233: \n234: \n235: class RegexSerializer(BaseSerializer):\nCode replaced for brevity.\n246: \n247: \n248: \n249: class SequenceSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n251: \n252: \n253: \n254: class SetSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n258: \n259: \n260: \n261: class SettingsReferenceSerializer(BaseSerializer):\nCode replaced for brevity.\n263: \n264: \n265: \n266: class TupleSerializer(BaseSequenceSerializer):\nCode replaced for brevity.\n270: \n271: \n272: \n273: class TypeSerializer(BaseSerializer):\n274:     def serialize(self):\n275:         special_cases = [\n276:             (models.Model, \"models.Model\", []),\n277:             (type(None), 'type(None)', []),\n278:         ]\n279:         for case, string, imports in special_cases:\n280:             if case is self.value:\n281:                 return string, set(imports)\n282:         if hasattr(self.value, \"__module__\"):\n283:             module = self.value.__module__\n284:             if module == builtins.__name__:\n285:                 return self.value.__name__, set()\n286:             else:\n287:                 return \"%s.%s\" % (module, self.value.__qualname__), {\"import %s\" % module}\n288: \n289: \n290: class UUIDSerializer(BaseSerializer):\nCode replaced for brevity.\n292: \n293: \n294: \n295: class Serializer:\nCode replaced for brevity.\n328: \n329: \n330: \n331: def serializer_factory(value):\nCode replaced for brevity.\n357: \n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/migrations/serializer.py",
      "suspect_lines": [
        276
      ]
    }
  ]
}