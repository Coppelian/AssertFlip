{
  "instance_id": "sphinx-doc__sphinx-9673",
  "problem_statement": "autodoc_typehints_description_target not working with Napoleon\n### Describe the bug\n\nI was trying to use the config option `autodoc_typehints_description_target = \"documented\"` combined with the Napoleon plugin (using Google style).\r\n\r\nThe return types were missing from the resulting documentation.\r\n\r\n\n\n### How to Reproduce\n\nJust generate the documentation using Napoleon and the config options:\r\n```python\r\nautodoc_typehints = \"description\"\r\nautodoc_typehints_description_target = \"documented\"\r\n\r\nnapoleon_numpy_docstring = False\r\n```\r\n\r\nGenerate the documentation of a function with the following docstring:\r\n\r\n```\r\n\"\"\"\r\nDescription.\r\n\r\nParameters:\r\n    param1: First parameter.\r\n    param2: Second parameter.\r\n\r\nReturns:\r\n    The returned value.\r\n\r\n\"\"\"\r\n```\n\n### Expected behavior\n\nAs the return is specified, the return type should be present in the documentation, either as a rtype section or as part of the return description.\n\n### Your project\n\nhttps://github.com/Tuxemon/Tuxemon\n\n### Screenshots\n\n![bildo](https://user-images.githubusercontent.com/2364173/133911607-f45de9af-c9e9-4d67-815f-4c571e70ec49.png)\r\n\n\n### OS\n\nWin\n\n### Python version\n\n3.8\n\n### Sphinx version\n\n4.2.0\n\n### Sphinx extensions\n\n    'sphinx.ext.autodoc',     'sphinx.ext.todo',     'sphinx.ext.viewcode',     'sphinx.ext.githubpages',     'sphinx.ext.napoleon',\n\n### Extra tools\n\n_No response_\n\n### Additional context\n\n_No response_\n",
  "localized_code": "[start of sphinx/ext/autodoc/typehints.py]\n1: \"\"\"\n2:     sphinx.ext.autodoc.typehints\n3:     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n4: \n5:     Generating content for autodoc using typehints\n6: \n7:     :copyright: Copyright 2007-2021 by the Sphinx team, see AUTHORS.\n8:     :license: BSD, see LICENSE for details.\n9: \"\"\"\n10: \n11: import re\n12: from collections import OrderedDict\n13: from typing import Any, Dict, Iterable, Set, cast\n14: \n15: from docutils import nodes\n16: from docutils.nodes import Element\n17: \n18: from sphinx import addnodes\n19: from sphinx.application import Sphinx\n20: from sphinx.util import inspect, typing\n21: \n22: \n23: def record_typehints(app: Sphinx, objtype: str, name: str, obj: Any,\n24:                      options: Dict, args: str, retann: str) -> None:\n25:     \"\"\"Record type hints to env object.\"\"\"\n26:     try:\n27:         if callable(obj):\n28:             annotations = app.env.temp_data.setdefault('annotations', {})\n29:             annotation = annotations.setdefault(name, OrderedDict())\n30:             sig = inspect.signature(obj, type_aliases=app.config.autodoc_type_aliases)\n31:             for param in sig.parameters.values():\n32:                 if param.annotation is not param.empty:\n33:                     annotation[param.name] = typing.stringify(param.annotation)\n34:             if sig.return_annotation is not sig.empty:\n35:                 annotation['return'] = typing.stringify(sig.return_annotation)\n36:     except (TypeError, ValueError):\n37:         pass\n38: \n39: \n40: def merge_typehints(app: Sphinx, domain: str, objtype: str, contentnode: Element) -> None:\n41:     if domain != 'py':\n42:         return\n43:     if app.config.autodoc_typehints not in ('both', 'description'):\n44:         return\n45: \n46:     try:\n47:         signature = cast(addnodes.desc_signature, contentnode.parent[0])\n48:         if signature['module']:\n49:             fullname = '.'.join([signature['module'], signature['fullname']])\n50:         else:\n51:             fullname = signature['fullname']\n52:     except KeyError:\n53:         # signature node does not have valid context info for the target object\n54:         return\n55: \n56:     annotations = app.env.temp_data.get('annotations', {})\n57:     if annotations.get(fullname, {}):\n58:         field_lists = [n for n in contentnode if isinstance(n, nodes.field_list)]\n59:         if field_lists == []:\n60:             field_list = insert_field_list(contentnode)\n61:             field_lists.append(field_list)\n62: \n63:         for field_list in field_lists:\n64:             if app.config.autodoc_typehints_description_target == \"all\":\n65:                 modify_field_list(field_list, annotations[fullname])\n66:             else:\n67:                 augment_descriptions_with_types(field_list, annotations[fullname])\n68: \n69: \n70: def insert_field_list(node: Element) -> nodes.field_list:\nCode replaced for brevity.\n80: \n81: \n82: \n83: def modify_field_list(node: nodes.field_list, annotations: Dict[str, str]) -> None:\nCode replaced for brevity.\n127: \n128: \n129: \n130: def augment_descriptions_with_types(\n131:     node: nodes.field_list,\n132:     annotations: Dict[str, str],\n133: ) -> None:\n134:     fields = cast(Iterable[nodes.field], node)\n135:     has_description = set()  # type: Set[str]\n136:     has_type = set()  # type: Set[str]\n137:     for field in fields:\n138:         field_name = field[0].astext()\n139:         parts = re.split(' +', field_name)\n140:         if parts[0] == 'param':\n141:             if len(parts) == 2:\n142:                 # :param xxx:\n143:                 has_description.add(parts[1])\n144:             elif len(parts) > 2:\n145:                 # :param xxx yyy:\n146:                 name = ' '.join(parts[2:])\n147:                 has_description.add(name)\n148:                 has_type.add(name)\n149:         elif parts[0] == 'type':\n150:             name = ' '.join(parts[1:])\n151:             has_type.add(name)\n152:         elif parts[0] == 'return':\n153:             has_description.add('return')\n154:         elif parts[0] == 'rtype':\n155:             has_type.add('return')\n156: \n157:     # Add 'type' for parameters with a description but no declared type.\n158:     for name in annotations:\n159:         if name == 'return':\n160:             continue\n161:         if name in has_description and name not in has_type:\n162:             field = nodes.field()\n163:             field += nodes.field_name('', 'type ' + name)\n164:             field += nodes.field_body('', nodes.paragraph('', annotations[name]))\n165:             node += field\n166: \n167:     # Add 'rtype' if 'return' is present and 'rtype' isn't.\n168:     if 'return' in annotations:\n169:         if 'return' in has_description and 'return' not in has_type:\n170:             field = nodes.field()\n171:             field += nodes.field_name('', 'rtype')\n172:             field += nodes.field_body('', nodes.paragraph('', annotations['return']))\n173:             node += field\n174: \n175: \n176: def setup(app: Sphinx) -> Dict[str, Any]:\nCode replaced for brevity.\n184: \n\n",
  "line_level_localization": [
    {
      "filename": "/sphinx/ext/autodoc/typehints.py",
      "suspect_lines": [
        152,
        159
      ]
    }
  ]
}