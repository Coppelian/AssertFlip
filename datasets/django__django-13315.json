{
  "instance_id": "django__django-13315",
  "problem_statement": "limit_choices_to on a ForeignKey can render duplicate options in formfield\nDescription\n\t\nIf you pass a Q object as limit_choices_to on a ForeignKey field involving a join, you may end up with duplicate options in your form.\nSee regressiontest in patch for a clear view on the problem.\n",
  "localized_code": "[start of django/forms/models.py]\n1: \"\"\"\n2: Helper functions for creating Form classes from Django models\n3: and database field objects.\n4: \"\"\"\n5: import warnings\n6: from itertools import chain\n7: \n8: from django.core.exceptions import (\n9:     NON_FIELD_ERRORS, FieldError, ImproperlyConfigured, ValidationError,\n10: )\n11: from django.forms.fields import ChoiceField, Field\n12: from django.forms.forms import BaseForm, DeclarativeFieldsMetaclass\n13: from django.forms.formsets import BaseFormSet, formset_factory\n14: from django.forms.utils import ErrorList\n15: from django.forms.widgets import (\n16:     HiddenInput, MultipleHiddenInput, RadioSelect, SelectMultiple,\n17: )\n18: from django.utils.deprecation import RemovedInDjango40Warning\n19: from django.utils.text import capfirst, get_text_list\n20: from django.utils.translation import gettext, gettext_lazy as _\n21: \n22: __all__ = (\n23:     'ModelForm', 'BaseModelForm', 'model_to_dict', 'fields_for_model',\n24:     'ModelChoiceField', 'ModelMultipleChoiceField', 'ALL_FIELDS',\n25:     'BaseModelFormSet', 'modelformset_factory', 'BaseInlineFormSet',\n26:     'inlineformset_factory', 'modelform_factory',\n27: )\n28: \n29: ALL_FIELDS = '__all__'\n30: \n31: \n32: def construct_instance(form, instance, fields=None, exclude=None):\n33:     \"\"\"\n34:     Construct and return a model instance from the bound ``form``'s\n35:     ``cleaned_data``, but do not save the returned instance to the database.\n36:     \"\"\"\n37:     from django.db import models\n38:     opts = instance._meta\n39: \n40:     cleaned_data = form.cleaned_data\n41:     file_field_list = []\n42:     for f in opts.fields:\n43:         if not f.editable or isinstance(f, models.AutoField) \\\n44:                 or f.name not in cleaned_data:\n45:             continue\n46:         if fields is not None and f.name not in fields:\n47:             continue\n48:         if exclude and f.name in exclude:\n49:             continue\n50:         # Leave defaults for fields that aren't in POST data, except for\n51:         # checkbox inputs because they don't appear in POST data if not checked.\n52:         if (\n53:             f.has_default() and\n54:             form[f.name].field.widget.value_omitted_from_data(form.data, form.files, form.add_prefix(f.name)) and\n55:             cleaned_data.get(f.name) in form[f.name].field.empty_values\n56:         ):\n57:             continue\n58:         # Defer saving file-type fields until after the other fields, so a\n59:         # callable upload_to can use the values from other fields.\n60:         if isinstance(f, models.FileField):\n61:             file_field_list.append(f)\n62:         else:\n63:             f.save_form_data(instance, cleaned_data[f.name])\n64: \n65:     for f in file_field_list:\n66:         f.save_form_data(instance, cleaned_data[f.name])\n67: \n68:     return instance\n69: \n70: \n71: # ModelForms #################################################################\n72: \n73: def model_to_dict(instance, fields=None, exclude=None):\nCode replaced for brevity.\n95: \n96: \n97: \n98: def apply_limit_choices_to_to_formfield(formfield):\n99:     \"\"\"Apply limit_choices_to to the formfield's queryset if needed.\"\"\"\n100:     if hasattr(formfield, 'queryset') and hasattr(formfield, 'get_limit_choices_to'):\n101:         limit_choices_to = formfield.get_limit_choices_to()\n102:         if limit_choices_to is not None:\n103:             formfield.queryset = formfield.queryset.complex_filter(limit_choices_to)\n104: \n105: \n106:                      field_classes=None, *, apply_limit_choices_to=True):\nCode replaced for brevity.\n192: \n193: \n194: \n195: class ModelFormOptions:\nCode replaced for brevity.\n205: \n206: \n207: \n208: class ModelFormMetaclass(DeclarativeFieldsMetaclass):\nCode replaced for brevity.\n277: \n278: \n279: \n280: class BaseModelForm(BaseForm):\nCode replaced for brevity.\n468: \n469: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/forms/models.py",
      "suspect_lines": [
        102,
        103
      ]
    }
  ]
}