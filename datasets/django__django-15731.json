{
  "instance_id": "django__django-15731",
  "problem_statement": "inspect.signature() returns incorrect signature on manager methods.\nDescription\n\t \n\t\t(last modified by Shiva Kumar)\n\t \ninspect.signature returns incorrect signature information when used on queryset methods\nimport inspect\nfrom django.db import models\nclass Person(models.Model):\n\tname = models.CharField(max_length=100)\nprint(inspect.signature(Person.objects.bulk_create))\n# actual: (*args, **kwargs)\n# expected: (objs, batch_size=None, ignore_conflicts=False)\nipython and jupyter seem to internally use inspect.signature to show documentation when using the <obj>? command and they too show incorrect signature information:\n \nThe issue is due to the code at â€‹https://github.com/django/django/blob/fe2e1478464846638082219c933a4302e5cf3037/django/db/models/manager.py#L84\nAlthough we are ensuring the decorated method has the right name and docstring on lines 87 and 88, complete metadata is not copied.\nThe fix is to use functools.wraps instead of manually assigning name and docstring. wraps will take care of all the metadata and inspect.signature will return the expected output.\nIf the bug is acknowledged please assign the ticket to me, I would like to raise a PR for this.\n",
  "localized_code": "[start of django/db/models/manager.py]\n1: import copy\n2: import inspect\n3: from importlib import import_module\n4: \n5: from django.db import router\n6: from django.db.models.query import QuerySet\n7: \n8: \n9: class BaseManager:\n10:     # To retain order, track each time a Manager instance is created.\n11:     creation_counter = 0\n12: \n13:     # Set to True for the 'objects' managers that are automatically created.\n14:     auto_created = False\n15: \n16:     #: If set to True the manager will be serialized into migrations and will\n17:     #: thus be available in e.g. RunPython operations.\n18:     use_in_migrations = False\n19: \n20:     def __new__(cls, *args, **kwargs):\n21:         # Capture the arguments to make returning them trivial.\n22:         obj = super().__new__(cls)\n23:         obj._constructor_args = (args, kwargs)\n24:         return obj\n25: \n26:     def __init__(self):\n27:         super().__init__()\n28:         self._set_creation_counter()\n29:         self.model = None\n30:         self.name = None\n31:         self._db = None\n32:         self._hints = {}\n33: \n34:     def __str__(self):\n35:         \"\"\"Return \"app_label.model_label.manager_name\".\"\"\"\n36:         return \"%s.%s\" % (self.model._meta.label, self.name)\n37: \n38:     def __class_getitem__(cls, *args, **kwargs):\n39:         return cls\n40: \n41:     def deconstruct(self):\n42:         \"\"\"\n43:         Return a 5-tuple of the form (as_manager (True), manager_class,\n44:         queryset_class, args, kwargs).\n45: \n46:         Raise a ValueError if the manager is dynamically generated.\n47:         \"\"\"\n48:         qs_class = self._queryset_class\n49:         if getattr(self, \"_built_with_as_manager\", False):\n50:             # using MyQuerySet.as_manager()\n51:             return (\n52:                 True,  # as_manager\n53:                 None,  # manager_class\n54:                 \"%s.%s\" % (qs_class.__module__, qs_class.__name__),  # qs_class\n55:                 None,  # args\n56:                 None,  # kwargs\n57:             )\n58:         else:\n59:             module_name = self.__module__\n60:             name = self.__class__.__name__\n61:             # Make sure it's actually there and not an inner class\n62:             module = import_module(module_name)\n63:             if not hasattr(module, name):\n64:                 raise ValueError(\n65:                     \"Could not find manager %s in %s.\\n\"\n66:                     \"Please note that you need to inherit from managers you \"\n67:                     \"dynamically generated with 'from_queryset()'.\"\n68:                     % (name, module_name)\n69:                 )\n70:             return (\n71:                 False,  # as_manager\n72:                 \"%s.%s\" % (module_name, name),  # manager_class\n73:                 None,  # qs_class\n74:                 self._constructor_args[0],  # args\n75:                 self._constructor_args[1],  # kwargs\n76:             )\n77: \n78:     def check(self, **kwargs):\n79:         return []\n80: \n81:     @classmethod\n82:     def _get_queryset_methods(cls, queryset_class):\n83:         def create_method(name, method):\n84:             def manager_method(self, *args, **kwargs):\n85:                 return getattr(self.get_queryset(), name)(*args, **kwargs)\n86: \n87:             manager_method.__name__ = method.__name__\n88:             manager_method.__doc__ = method.__doc__\n89:             return manager_method\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/models/manager.py",
      "suspect_lines": [
        87,
        88
      ]
    }
  ]
}