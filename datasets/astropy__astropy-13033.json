{
  "instance_id": "astropy__astropy-13033",
  "problem_statement": "TimeSeries: misleading exception when required column check fails.\n<!-- This comments are hidden when you submit the issue,\r\nso you do not need to remove them! -->\r\n\r\n<!-- Please be sure to check out our contributing guidelines,\r\nhttps://github.com/astropy/astropy/blob/main/CONTRIBUTING.md .\r\nPlease be sure to check out our code of conduct,\r\nhttps://github.com/astropy/astropy/blob/main/CODE_OF_CONDUCT.md . -->\r\n\r\n<!-- Please have a search on our GitHub repository to see if a similar\r\nissue has already been posted.\r\nIf a similar issue is closed, have a quick look to see if you are satisfied\r\nby the resolution.\r\nIf not please go ahead and open an issue! -->\r\n\r\n<!-- Please check that the development version still produces the same bug.\r\nYou can install development version with\r\npip install git+https://github.com/astropy/astropy\r\ncommand. -->\r\n\r\n### Description\r\n<!-- Provide a general description of the bug. -->\r\n\r\nFor a `TimeSeries` object that has additional required columns (in addition to `time`), when codes mistakenly try to remove a required column, the exception it produces is misleading.\r\n\r\n### Expected behavior\r\n<!-- What did you expect to happen. -->\r\nAn exception that informs the users required columns are missing.\r\n\r\n### Actual behavior\r\nThe actual exception message is confusing:\r\n`ValueError: TimeSeries object is invalid - expected 'time' as the first columns but found 'time'`\r\n\r\n### Steps to Reproduce\r\n<!-- Ideally a code example could be provided so we can run it ourselves. -->\r\n<!-- If you are pasting code, use triple backticks (```) around\r\nyour code snippet. -->\r\n<!-- If necessary, sanitize your screen output to be pasted so you do not\r\nreveal secrets like tokens and passwords. -->\r\n\r\n```python\r\nfrom astropy.time import Time\r\nfrom astropy.timeseries import TimeSeries\r\n\r\ntime=Time(np.arange(100000, 100003), format='jd')\r\nts = TimeSeries(time=time, data = {\"flux\": [99.9, 99.8, 99.7]})\r\nts._required_columns = [\"time\", \"flux\"]                                   \r\nts.remove_column(\"flux\")\r\n\r\n```\r\n\r\n### System Details\r\n<!-- Even if you do not think this is necessary, it is useful information for the maintainers.\r\nPlease run the following snippet and paste the output below:\r\nimport platform; print(platform.platform())\r\nimport sys; print(\"Python\", sys.version)\r\nimport numpy; print(\"Numpy\", numpy.__version__)\r\nimport erfa; print(\"pyerfa\", erfa.__version__)\r\nimport astropy; print(\"astropy\", astropy.__version__)\r\nimport scipy; print(\"Scipy\", scipy.__version__)\r\nimport matplotlib; print(\"Matplotlib\", matplotlib.__version__)\r\n-->\r\n```\r\nWindows-10-10.0.22000-SP0\r\nPython 3.9.10 | packaged by conda-forge | (main, Feb  1 2022, 21:21:54) [MSC v.1929 64 bit (AMD64)]\r\nNumpy 1.22.3\r\npyerfa 2.0.0.1\r\nastropy 5.0.3\r\nScipy 1.8.0\r\nMatplotlib 3.5.1\r\n```\n",
  "localized_code": "[start of astropy/timeseries/core.py]\n1: # Licensed under a 3-clause BSD style license - see LICENSE.rst\n2: \n3: from types import FunctionType\n4: from contextlib import contextmanager\n5: from functools import wraps\n6: \n7: from astropy.table import QTable\n8: \n9: __all__ = ['BaseTimeSeries', 'autocheck_required_columns']\n10: \n11: COLUMN_RELATED_METHODS = ['add_column',\n12:                           'add_columns',\n13:                           'keep_columns',\n14:                           'remove_column',\n15:                           'remove_columns',\n16:                           'rename_column']\n17: \n18: \n19: def autocheck_required_columns(cls):\n20:     \"\"\"\n21:     This is a decorator that ensures that the table contains specific\n22:     methods indicated by the _required_columns attribute. The aim is to\n23:     decorate all methods that might affect the columns in the table and check\n24:     for consistency after the methods have been run.\n25:     \"\"\"\n26: \n27:     def decorator_method(method):\n28: \n29:         @wraps(method)\n30:         def wrapper(self, *args, **kwargs):\n31:             result = method(self, *args, **kwargs)\n32:             self._check_required_columns()\n33:             return result\n34: \n35:         return wrapper\n36: \n37:     for name in COLUMN_RELATED_METHODS:\n38:         if (not hasattr(cls, name) or\n39:                 not isinstance(getattr(cls, name), FunctionType)):\n40:             raise ValueError(f\"{name} is not a valid method\")\n41:         setattr(cls, name, decorator_method(getattr(cls, name)))\n42: \n43:     return cls\n44: \n45: \n46: class BaseTimeSeries(QTable):\n47: \n48:     _required_columns = None\n49:     _required_columns_enabled = True\n50: \n51:     # If _required_column_relax is True, we don't require the columns to be\n52:     # present but we do require them to be the correct ones IF present. Note\n53:     # that this is a temporary state - as soon as the required columns\n54:     # are all present, we toggle this to False\n55:     _required_columns_relax = False\n56: \n57:     def _check_required_columns(self):\n58: \n59:         if not self._required_columns_enabled:\n60:             return\n61: \n62:         if self._required_columns is not None:\n63: \n64:             if self._required_columns_relax:\n65:                 required_columns = self._required_columns[:len(self.colnames)]\n66:             else:\n67:                 required_columns = self._required_columns\n68: \n69:             plural = 's' if len(required_columns) > 1 else ''\n70: \n71:             if not self._required_columns_relax and len(self.colnames) == 0:\n72: \n73:                 raise ValueError(\"{} object is invalid - expected '{}' \"\n74:                                  \"as the first column{} but time series has no columns\"\n75:                                  .format(self.__class__.__name__, required_columns[0], plural))\n76: \n77:             elif self.colnames[:len(required_columns)] != required_columns:\n78: \n79:                 raise ValueError(\"{} object is invalid - expected '{}' \"\n80:                                  \"as the first column{} but found '{}'\"\n81:                                  .format(self.__class__.__name__, required_columns[0], plural, self.colnames[0]))\n82: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/astropy/timeseries/core.py",
      "suspect_lines": [
        79,
        80,
        81
      ]
    }
  ]
}