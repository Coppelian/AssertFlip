{
  "instance_id": "sphinx-doc__sphinx-11445",
  "problem_statement": "Using rst_prolog removes top level headings containing a domain directive\n### Describe the bug\r\n\r\nIf `rst_prolog` is set, then any documents that contain a domain directive as the first heading (eg `:mod:`) do not render the heading correctly or include the heading in the toctree.\r\n\r\nIn the example below, if the heading of `docs/mypackage.rst` were `mypackage2` instead of `:mod:mypackage2` then the heading displays correctly.\r\nSimilarly, if you do not set `rst_prolog` then the heading will display correctly.\r\n\r\nThis appears to have been broken for some time because I can reproduce it in v4.0.0 of Sphinx\r\n\r\n### How to Reproduce\r\n\r\n```bash\r\n$ sphinx-quickstart --no-sep --project mypackage --author me -v 0.1.0 --release 0.1.0 --language en docs\r\n$ echo -e 'Welcome\\n=======\\n\\n.. toctree::\\n\\n   mypackage\\n' > docs/index.rst\r\n$ echo -e ':mod:`mypackage2`\\n=================\\n\\nContent\\n\\nSubheading\\n----------\\n' > docs/mypackage.rst\r\n$ echo -e 'rst_prolog = \"\"\"\\n.. |psf| replace:: Python Software Foundation\\n\"\"\"\\n' >> docs/conf.py\r\n$ sphinx-build -b html . _build\r\n$ grep 'mypackage2' docs/_build/index.html\r\n```\r\n\r\n`docs/index.rst`:\r\n\r\n```rst\r\nWelcome\r\n=======\r\n\r\n.. toctree::\r\n\r\n   mypackage\r\n```\r\n\r\n`docs/mypackage.rst`:\r\n\r\n```rst\r\n:mod:`mypackage2`\r\n=================\r\n\r\nContent\r\n\r\nSubheading\r\n----------\r\n```\r\n\r\n### Environment Information\r\n\r\n```text\r\nPlatform:              linux; (Linux-6.3.2-arch1-1-x86_64-with-glibc2.37)\r\nPython version:        3.11.3 (main, Apr  5 2023, 15:52:25) [GCC 12.2.1 20230201])\r\nPython implementation: CPython\r\nSphinx version:        7.1.0+/d3c91f951\r\nDocutils version:      0.20.1\r\nJinja2 version:        3.1.2\r\nPygments version:      2.15.1\r\n```\r\n\r\n\r\n### Sphinx extensions\r\n\r\n```python\r\n[]\r\n```\r\n\r\n\r\n### Additional context\r\n\r\n_No response_\n",
  "localized_code": "[start of sphinx/util/rst.py]\n1: \"\"\"reST helper functions.\"\"\"\n2: \n3: from __future__ import annotations\n4: \n5: import re\n6: from collections import defaultdict\n7: from contextlib import contextmanager\n8: from typing import Generator\n9: from unicodedata import east_asian_width\n10: \n11: from docutils.parsers.rst import roles\n12: from docutils.parsers.rst.languages import en as english\n13: from docutils.statemachine import StringList\n14: from docutils.utils import Reporter\n15: from jinja2 import Environment\n16: \n17: from sphinx.locale import __\n18: from sphinx.util import docutils, logging\n19: \n20: try:\n21:     from jinja2.utils import pass_environment\n22: except ImportError:\n23:     from jinja2 import environmentfilter as pass_environment\n24: \n25: \n26: logger = logging.getLogger(__name__)\n27: \n28: docinfo_re = re.compile(':\\\\w+:.*?')\n29: symbols_re = re.compile(r'([!-\\-/:-@\\[-`{-~])')  # symbols without dot(0x2e)\n30: SECTIONING_CHARS = ['=', '-', '~']\n31: \n32: # width of characters\n33: WIDECHARS: dict[str, str] = defaultdict(lambda: \"WF\")  # WF: Wide + Full-width\n34: WIDECHARS[\"ja\"] = \"WFA\"  # In Japanese, Ambiguous characters also have double width\n35: \n36: \n37: def escape(text: str) -> str:\n38:     text = symbols_re.sub(r'\\\\\\1', text)\n39:     text = re.sub(r'^\\.', r'\\.', text)  # escape a dot at top\n40:     return text\n41: \n42: \n43: def textwidth(text: str, widechars: str = 'WF') -> int:\n44:     \"\"\"Get width of text.\"\"\"\n45:     def charwidth(char: str, widechars: str) -> int:\n46:         if east_asian_width(char) in widechars:\n47:             return 2\n48:         else:\n49:             return 1\n50: \n51:     return sum(charwidth(c, widechars) for c in text)\n52: \n53: \n54: @pass_environment\n55: def heading(env: Environment, text: str, level: int = 1) -> str:\nCode replaced for brevity.\n60: \n61: \n62: \n63: @contextmanager\n64: def default_role(docname: str, name: str) -> Generator[None, None, None]:\nCode replaced for brevity.\n75: \n76: \n77: \n78: def prepend_prolog(content: StringList, prolog: str) -> None:\n79:     \"\"\"Prepend a string to content body as prolog.\"\"\"\n80:     if prolog:\n81:         pos = 0\n82:         for line in content:\n83:             if docinfo_re.match(line):\n84:                 pos += 1\n85:             else:\n86:                 break\n87: \n88:         if pos > 0:\n89:             # insert a blank line after docinfo\n90:             content.insert(pos, '', '<generated>', 0)\n91:             pos += 1\n92: \n93:         # insert prolog (after docinfo if exists)\n94:         for lineno, line in enumerate(prolog.splitlines()):\n95:             content.insert(pos + lineno, line, '<rst_prolog>', lineno)\n96: \n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/sphinx/util/rst.py",
      "suspect_lines": [
        15,
        20,
        21,
        22,
        23,
        24,
        25,
        28,
        83
      ]
    }
  ]
}