{
  "instance_id": "sympy__sympy-19637",
  "problem_statement": "kernS: 'kern' referenced before assignment\nfrom sympy.core.sympify import kernS\r\n\r\ntext = \"(2*x)/(x-1)\"\r\nexpr = kernS(text)  \r\n//  hit = kern in s\r\n// UnboundLocalError: local variable 'kern' referenced before assignment\n",
  "localized_code": "[start of sympy/core/sympify.py]\n1: \"\"\"sympify -- convert objects SymPy internal format\"\"\"\n2: \n3: from typing import Dict, Type, Callable, Any\n4: \n5: from inspect import getmro\n6: \n7: from .compatibility import iterable\n8: from .parameters import global_parameters\n9: \n10: \n11: class SympifyError(ValueError):\n12:     def __init__(self, expr, base_exc=None):\n13:         self.expr = expr\n14:         self.base_exc = base_exc\n15: \n16:     def __str__(self):\n17:         if self.base_exc is None:\n18:             return \"SympifyError: %r\" % (self.expr,)\n19: \n20:         return (\"Sympify of expression '%s' failed, because of exception being \"\n21:             \"raised:\\n%s: %s\" % (self.expr, self.base_exc.__class__.__name__,\n22:             str(self.base_exc)))\n23: \n24: \n25: # See sympify docstring.\n26: converter = {}  # type: Dict[Type[Any], Callable[[Any], Basic]]\n27: \n28: \n29: class CantSympify:\n30:     \"\"\"\n31:     Mix in this trait to a class to disallow sympification of its instances.\n32: \n33:     Examples\n34:     ========\n35: \n36:     >>> from sympy.core.sympify import sympify, CantSympify\n37: \n38:     >>> class Something(dict):\n39:     ...     pass\n40:     ...\n41:     >>> sympify(Something())\n42:     {}\n43: \n44:     >>> class Something(dict, CantSympify):\n45:     ...     pass\n46:     ...\n47:     >>> sympify(Something())\n48:     Traceback (most recent call last):\n49:     ...\n50:     SympifyError: SympifyError: {}\n51: \n52:     \"\"\"\n53:     pass\n54: \n55: \n56: def _is_numpy_instance(a):\nCode replaced for brevity.\n63: \n64: \n65: \n66: def _convert_numpy_types(a, **sympify_args):\nCode replaced for brevity.\n87: \n88: \n89: \n90:         evaluate=None):\nCode replaced for brevity.\n410: \n411: \n412: \n413: def _sympify(a):\nCode replaced for brevity.\n439: \n440: \n441: \n442: def kernS(s):\n443:     \"\"\"Use a hack to try keep autosimplification from distributing a\n444:     a number into an Add; this modification doesn't\n445:     prevent the 2-arg Mul from becoming an Add, however.\n446: \n447:     Examples\n448:     ========\n449: \n450:     >>> from sympy.core.sympify import kernS\n451:     >>> from sympy.abc import x, y\n452: \n453:     The 2-arg Mul distributes a number (or minus sign) across the terms\n454:     of an expression, but kernS will prevent that:\n455: \n456:     >>> 2*(x + y), -(x + 1)\n457:     (2*x + 2*y, -x - 1)\n458:     >>> kernS('2*(x + y)')\n459:     2*(x + y)\n460:     >>> kernS('-(x + 1)')\n461:     -(x + 1)\n462: \n463:     If use of the hack fails, the un-hacked string will be passed to sympify...\n464:     and you get what you get.\n465: \n466:     XXX This hack should not be necessary once issue 4596 has been resolved.\n467:     \"\"\"\n468:     import string\n469:     from random import choice\n470:     from sympy.core.symbol import Symbol\n471:     hit = False\n472:     quoted = '\"' in s or \"'\" in s\n473:     if '(' in s and not quoted:\n474:         if s.count('(') != s.count(\")\"):\n475:             raise SympifyError('unmatched left parenthesis')\n476: \n477:         # strip all space from s\n478:         s = ''.join(s.split())\n479:         olds = s\n480:         # now use space to represent a symbol that\n481:         # will\n482:         # step 1. turn potential 2-arg Muls into 3-arg versions\n483:         # 1a. *( -> * *(\n484:         s = s.replace('*(', '* *(')\n485:         # 1b. close up exponentials\n486:         s = s.replace('** *', '**')\n487:         # 2. handle the implied multiplication of a negated\n488:         # parenthesized expression in two steps\n489:         # 2a:  -(...)  -->  -( *(...)\n490:         target = '-( *('\n491:         s = s.replace('-(', target)\n492:         # 2b: double the matching closing parenthesis\n493:         # -( *(...)  -->  -( *(...))\n494:         i = nest = 0\n495:         assert target.endswith('(')  # assumption below\n496:         while True:\n497:             j = s.find(target, i)\n498:             if j == -1:\n499:                 break\n500:             j += len(target) - 1\n501:             for j in range(j, len(s)):\n502:                 if s[j] == \"(\":\n503:                     nest += 1\n504:                 elif s[j] == \")\":\n505:                     nest -= 1\n506:                 if nest == 0:\n507:                     break\n508:             s = s[:j] + \")\" + s[j:]\n509:             i = j + 2  # the first char after 2nd )\n510:         if ' ' in s:\n511:             # get a unique kern\n512:             kern = '_'\n513:             while kern in s:\n514:                 kern += choice(string.ascii_letters + string.digits)\n515:             s = s.replace(' ', kern)\n516:         hit = kern in s\n517: \n518:     for i in range(2):\n519:         try:\n520:             expr = sympify(s)\n521:             break\n522:         except TypeError:  # the kern might cause unknown errors...\n523:             if hit:\n524:                 s = olds  # maybe it didn't like the kern; use un-kerned s\n525:                 hit = False\n526:                 continue\n527:             expr = sympify(s)  # let original error raise\n528: \n529:     if not hit:\n530:         return expr\n531: \n532:     rep = {Symbol(kern): 1}\n533:     def _clear(expr):\n534:         if isinstance(expr, (list, tuple, set)):\n535:             return type(expr)([_clear(e) for e in expr])\n536:         if hasattr(expr, 'subs'):\n537:             return expr.subs(rep, hack2=True)\n538:         return expr\n539:     expr = _clear(expr)\n540:     # hope that kern is not there anymore\n541:     return expr\n542: \n543: \n544: # Avoid circular import\n545: from .basic import Basic\n\n",
  "line_level_localization": [
    {
      "filename": "/sympy/core/sympify.py",
      "suspect_lines": [
        516
      ]
    }
  ]
}