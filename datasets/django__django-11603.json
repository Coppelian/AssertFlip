{
  "instance_id": "django__django-11603",
  "problem_statement": "Add DISTINCT support for Avg and Sum aggregates.\nDescription\n\t\nAs an extension of #28658, aggregates should be supported for other general aggregates such as Avg and Sum. Before 2.2, these aggregations just ignored the parameter, but now throw an exception.\nThis change would just involve setting these classes as allowing DISTINCT, and could also be applied to Min and Max (although pointless).\n",
  "localized_code": "[start of django/db/models/aggregates.py]\n1: \"\"\"\n2: Classes to represent the definitions of aggregate functions.\n3: \"\"\"\n4: from django.core.exceptions import FieldError\n5: from django.db.models.expressions import Case, Func, Star, When\n6: from django.db.models.fields import IntegerField\n7: from django.db.models.functions.mixins import (\n8:     FixDurationInputMixin, NumericOutputFieldMixin,\n9: )\n10: \n11: __all__ = [\n12:     'Aggregate', 'Avg', 'Count', 'Max', 'Min', 'StdDev', 'Sum', 'Variance',\n13: ]\n14: \n15: \n16: class Aggregate(Func):\n17:     template = '%(function)s(%(distinct)s%(expressions)s)'\n18:     contains_aggregate = True\n19:     name = None\n20:     filter_template = '%s FILTER (WHERE %%(filter)s)'\n21:     window_compatible = True\n22:     allow_distinct = False\n23: \n24:     def __init__(self, *expressions, distinct=False, filter=None, **extra):\n25:         if distinct and not self.allow_distinct:\n26:             raise TypeError(\"%s does not allow distinct.\" % self.__class__.__name__)\n27:         self.distinct = distinct\n28:         self.filter = filter\n29:         super().__init__(*expressions, **extra)\n30: \n31:     def get_source_fields(self):\n32:         # Don't return the filter expression since it's not a source field.\n33:         return [e._output_field_or_none for e in super().get_source_expressions()]\n34: \n35:     def get_source_expressions(self):\n36:         source_expressions = super().get_source_expressions()\n37:         if self.filter:\n38:             return source_expressions + [self.filter]\n39:         return source_expressions\n40: \n41:     def set_source_expressions(self, exprs):\n42:         self.filter = self.filter and exprs.pop()\n43:         return super().set_source_expressions(exprs)\n44: \n45:     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):\n46:         # Aggregates are not allowed in UPDATE queries, so ignore for_save\n47:         c = super().resolve_expression(query, allow_joins, reuse, summarize)\n48:         c.filter = c.filter and c.filter.resolve_expression(query, allow_joins, reuse, summarize)\n49:         if not summarize:\n50:             # Call Aggregate.get_source_expressions() to avoid\n51:             # returning self.filter and including that in this loop.\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/django/db/models/aggregates.py",
      "suspect_lines": []
    }
  ]
}