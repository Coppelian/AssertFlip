{
  "instance_id": "astropy__astropy-12907",
  "problem_statement": "Modeling's `separability_matrix` does not compute separability correctly for nested CompoundModels\nConsider the following model:\r\n\r\n```python\r\nfrom astropy.modeling import models as m\r\nfrom astropy.modeling.separable import separability_matrix\r\n\r\ncm = m.Linear1D(10) & m.Linear1D(5)\r\n```\r\n\r\nIt's separability matrix as you might expect is a diagonal:\r\n\r\n```python\r\n>>> separability_matrix(cm)\r\narray([[ True, False],\r\n       [False,  True]])\r\n```\r\n\r\nIf I make the model more complex:\r\n```python\r\n>>> separability_matrix(m.Pix2Sky_TAN() & m.Linear1D(10) & m.Linear1D(5))\r\narray([[ True,  True, False, False],\r\n       [ True,  True, False, False],\r\n       [False, False,  True, False],\r\n       [False, False, False,  True]])\r\n```\r\n\r\nThe output matrix is again, as expected, the outputs and inputs to the linear models are separable and independent of each other.\r\n\r\nIf however, I nest these compound models:\r\n```python\r\n>>> separability_matrix(m.Pix2Sky_TAN() & cm)\r\narray([[ True,  True, False, False],\r\n       [ True,  True, False, False],\r\n       [False, False,  True,  True],\r\n       [False, False,  True,  True]])\r\n```\r\nSuddenly the inputs and outputs are no longer separable?\r\n\r\nThis feels like a bug to me, but I might be missing something?\n",
  "localized_code": "[start of astropy/modeling/separable.py]\n1: # Licensed under a 3-clause BSD style license - see LICENSE.rst\n2: \n3: \"\"\"\n4: Functions to determine if a model is separable, i.e.\n5: if the model outputs are independent.\n6: \n7: It analyzes ``n_inputs``, ``n_outputs`` and the operators\n8: in a compound model by stepping through the transforms\n9: and creating a ``coord_matrix`` of shape (``n_outputs``, ``n_inputs``).\n10: \n11: \n12: Each modeling operator is represented by a function which\n13: takes two simple models (or two ``coord_matrix`` arrays) and\n14: returns an array of shape (``n_outputs``, ``n_inputs``).\n15: \n16: \"\"\"\n17: \n18: import numpy as np\n19: \n20: from .core import Model, ModelDefinitionError, CompoundModel\n21: from .mappings import Mapping\n22: \n23: \n24: __all__ = [\"is_separable\", \"separability_matrix\"]\n25: \n26: \n27: def is_separable(transform):\n28:     \"\"\"\n29:     A separability test for the outputs of a transform.\n30: \n31:     Parameters\n32:     ----------\n33:     transform : `~astropy.modeling.core.Model`\n34:         A (compound) model.\n35: \n36:     Returns\n37:     -------\n38:     is_separable : ndarray\n39:         A boolean array with size ``transform.n_outputs`` where\n40:         each element indicates whether the output is independent\n41:         and the result of a separable transform.\n42: \n43:     Examples\n44:     --------\n45:     >>> from astropy.modeling.models import Shift, Scale, Rotation2D, Polynomial2D\n46:     >>> is_separable(Shift(1) & Shift(2) | Scale(1) & Scale(2))\n47:         array([ True,  True]...)\n48:     >>> is_separable(Shift(1) & Shift(2) | Rotation2D(2))\n49:         array([False, False]...)\n50:     >>> is_separable(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]) | \\\n51:         Polynomial2D(1) & Polynomial2D(2))\n52:         array([False, False]...)\n53:     >>> is_separable(Shift(1) & Shift(2) | Mapping([0, 1, 0, 1]))\n54:         array([ True,  True,  True,  True]...)\n55: \n56:     \"\"\"\n57:     if transform.n_inputs == 1 and transform.n_outputs > 1:\n58:         is_separable = np.array([False] * transform.n_outputs).T\n59:         return is_separable\n60:     separable_matrix = _separable(transform)\n61:     is_separable = separable_matrix.sum(1)\n62:     is_separable = np.where(is_separable != 1, False, True)\n63:     return is_separable\n64: \n65: \n66: def separability_matrix(transform):\nCode replaced for brevity.\n102: \n103: \n104: \n105: def _compute_n_outputs(left, right):\nCode replaced for brevity.\n127: \n128: \n129: \n130: def _arith_oper(left, right):\nCode replaced for brevity.\n168: \n169: \n170: \n171: def _coord_matrix(model, pos, noutp):\nCode replaced for brevity.\n216: \n217: \n218: \n219: def _cstack(left, right):\n220:     \"\"\"\n221:     Function corresponding to '&' operation.\n222: \n223:     Parameters\n224:     ----------\n225:     left, right : `astropy.modeling.Model` or ndarray\n226:         If input is of an array, it is the output of `coord_matrix`.\n227: \n228:     Returns\n229:     -------\n230:     result : ndarray\n231:         Result from this operation.\n232: \n233:     \"\"\"\n234:     noutp = _compute_n_outputs(left, right)\n235: \n236:     if isinstance(left, Model):\n237:         cleft = _coord_matrix(left, 'left', noutp)\n238:     else:\n239:         cleft = np.zeros((noutp, left.shape[1]))\n240:         cleft[: left.shape[0], : left.shape[1]] = left\n241:     if isinstance(right, Model):\n242:         cright = _coord_matrix(right, 'right', noutp)\n243:     else:\n244:         cright = np.zeros((noutp, right.shape[1]))\n245:         cright[-right.shape[0]:, -right.shape[1]:] = 1\n246: \n247:     return np.hstack([cleft, cright])\n248: \n249: \n250: def _cdot(left, right):\nCode replaced for brevity.\n287: \n288: \n289: \n290: def _separable(transform):\nCode replaced for brevity.\n311: \n312: \n313: \n314: # Maps modeling operators to a function computing and represents the\n315: # relationship of axes as an array of 0-es and 1-s\n316: _operators = {'&': _cstack, '|': _cdot, '+': _arith_oper, '-': _arith_oper,\n317:               '*': _arith_oper, '/': _arith_oper, '**': _arith_oper}\n\n",
  "line_level_localization": [
    {
      "filename": "/astropy/modeling/separable.py",
      "suspect_lines": [
        245
      ]
    }
  ]
}