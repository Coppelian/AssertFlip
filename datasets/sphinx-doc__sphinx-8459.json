{
  "instance_id": "sphinx-doc__sphinx-8459",
  "problem_statement": "autodoc_type_aliases doesn't work when autodoc_typehints is set to \"description\"\n**Describe the bug**\r\nautodoc_type_aliases doesn't work when autodoc_typehints is set to \"description\".\r\n\r\n**To Reproduce**\r\n\r\ntypes.py\r\n```python\r\nfrom __future__ import annotations\r\n\r\nfrom typing import Any, Dict\r\n\r\nJSONObject = Dict[str, Any]\r\n\r\n\r\ndef sphinx_doc(data: JSONObject) -> JSONObject:\r\n    \"\"\"Does it work.\r\n\r\n    Args:\r\n        data: Does it args.\r\n\r\n    Returns:\r\n        Does it work in return.\r\n    \"\"\"\r\n    return {}\r\n\r\n```\r\n\r\nconf.py\r\n```python\r\nautodoc_typehints = 'description'\r\nautodoc_type_aliases = {\r\n    'JSONObject': 'types.JSONObject',\r\n}\r\n```\r\n\r\nI get,\r\n```\r\ntypes.sphinx_doc(data)\r\nDoes it work.\r\n\r\nParameters\r\ndata (Dict[str, Any]) – Does it args.\r\n\r\nReturns\r\nDoes it work in return.\r\n\r\nReturn type\r\nDict[str, Any]\r\n```\r\n\r\nThen if I remove `autodoc_typehints = 'description'`\r\nI get,\r\n```\r\ntypes.sphinx_doc(data: types.JSONObject) → types.JSONObject\r\nDoes it work.\r\n\r\nParameters\r\ndata – Does it args.\r\n\r\nReturns\r\nDoes it work in return.\r\n```\r\n\r\n**Expected behavior**\r\n\r\n`types.JSONObject` instead of `Dict[str, Any]` in both cases.\r\n\r\n\r\n**Environment info**\r\n- OS: Mac Catalina 10.15.7\r\n- Python version: 3.7.9\r\n- Sphinx version: 3.3.1\r\n- Sphinx extensions:      sphinx.ext.autodoc, sphinx.ext.napoleon, sphinxarg.ext\r\n\r\n\n",
  "localized_code": "[start of sphinx/ext/autodoc/typehints.py]\n1: \"\"\"\n2:     sphinx.ext.autodoc.typehints\n3:     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n4: \n5:     Generating content for autodoc using typehints\n6: \n7:     :copyright: Copyright 2007-2020 by the Sphinx team, see AUTHORS.\n8:     :license: BSD, see LICENSE for details.\n9: \"\"\"\n10: \n11: import re\n12: from collections import OrderedDict\n13: from typing import Any, Dict, Iterable, cast\n14: \n15: from docutils import nodes\n16: from docutils.nodes import Element\n17: \n18: from sphinx import addnodes\n19: from sphinx.application import Sphinx\n20: from sphinx.util import inspect, typing\n21: \n22: \n23: def record_typehints(app: Sphinx, objtype: str, name: str, obj: Any,\n24:                      options: Dict, args: str, retann: str) -> None:\n25:     \"\"\"Record type hints to env object.\"\"\"\n26:     try:\n27:         if callable(obj):\n28:             annotations = app.env.temp_data.setdefault('annotations', {})\n29:             annotation = annotations.setdefault(name, OrderedDict())\n30:             sig = inspect.signature(obj)\n31:             for param in sig.parameters.values():\n32:                 if param.annotation is not param.empty:\n33:                     annotation[param.name] = typing.stringify(param.annotation)\n34:             if sig.return_annotation is not sig.empty:\n35:                 annotation['return'] = typing.stringify(sig.return_annotation)\n36:     except (TypeError, ValueError):\n37:         pass\n38: \n39: \n40: def merge_typehints(app: Sphinx, domain: str, objtype: str, contentnode: Element) -> None:\n41:     if domain != 'py':\n42:         return\n43:     if app.config.autodoc_typehints != 'description':\n44:         return\n45:     if objtype == 'class' and app.config.autoclass_content not in ('init', 'both'):\n46:         return\n47: \n48:     try:\n49:         signature = cast(addnodes.desc_signature, contentnode.parent[0])\n50:         if signature['module']:\n51:             fullname = '.'.join([signature['module'], signature['fullname']])\n... Code Truncated ...\n\n",
  "line_level_localization": [
    {
      "filename": "/sphinx/ext/autodoc/typehints.py",
      "suspect_lines": [
        30
      ]
    }
  ]
}